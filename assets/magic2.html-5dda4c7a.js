import{_ as c}from"./plugin-vue_export-helper-c27b6911.js";import{r as e,o as i,c as l,a as n,b as s,e as a,w as u,f as p}from"./app-00bf9ad3.js";const r="/imgs/go初始化流程图.png",k="/imgs/python_add栈操作.png",d="/imgs/LLVM替换.png",v={},m=n("h1",{id:"go-另外几个黑魔法技巧",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#go-另外几个黑魔法技巧","aria-hidden":"true"},"#"),s(" go 另外几个黑魔法技巧")],-1),b=p(`<p>而最近一段时间，笔者重新梳理了一下 go 知识点，并深入地看看了它的源码，在实践中又有了新的沉淀，于是写下这篇文章和大家分享一下。</p><h2 id="魔法-1-最小化运行时-minimal-runtime" tabindex="-1"><a class="header-anchor" href="#魔法-1-最小化运行时-minimal-runtime" aria-hidden="true">#</a> 魔法 1：最小化运行时(minimal runtime)</h2><p>我们知道，go 有一层很重的运行时(runtime)，包括内存管理、goroutine 调度等重要组件；这些组件极大地方便了应用程序的开发和迭代，但也带来了一些问题，比如：</p><ul><li>Go 程序自动接管了内存，并自带 GC，使我们无法直接操纵内存；</li><li>Go 程序自动化了内存、调度等重要模块，但这些组件本身就占用了一定资源；</li><li>.....</li></ul><p>对于应用程序而言，runtime 是良药，能够很大程度上简化机械工作，让开发者集中于核心业务开发和迭代上，但对于一些其它场景，比如操作系统，那么 runtime 会严重破坏其核心资源管理能力，那么有没有方案能让 go 摆脱掉 runtime 的束缚，使其成为一个真正的系统级编程语言呢？</p><p>肯定是有的，任何一个可执行文件而言，本质上都是目标文件被链接后生成的（以下均以 Linux 作为实践平台）。</p><p>go 编译器默认编译生成的文件，其程序的入口是 runtime 包中的 <code>_rt0_amd64_linux</code> 函数：</p><div class="language-s line-numbers-mode" data-ext="s"><pre class="language-s"><code>TEXT _rt0_amd64_linux(SB),NOSPLIT,$-8
	JMP	_rt0_amd64(SB)

TEXT _rt0_amd64(SB),NOSPLIT,$-8
	MOVQ	0(SP), DI	// argc
	LEAQ	8(SP), SI	// argv
	JMP	runtime·rt0_go(SB)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>经 _rt0_amd64_linux 入口跳转到 _rt0_amd64、 rt0_go；在 rt0_go 中，go 程序会初始化一系列的内存、调度、GC 等资源，如下图所示：</p><p><img src="`+r+`" alt="go初始化流程图.png"></p><p>每个 go 程序都会走这么一遭，这也是其 runtime 很重的原因；想要规避掉 runtime，那么最好的方法肯定是从根源入手，将程序入口 _rt0_amd64_linux 换掉，不再进入 rt0_go 函数，也就不会初始化 runtime，那么自然就能摆脱掉 runtime。</p><p>既然有了正确的思路，那么实现起来也就不会难了。</p><p>首先，我们从一个简单的 <code>Hello Runtime!</code> 入手：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// ....</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Hello Runtime!&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>绝大多数情况下，我们会选择 go run 来运行这个简单的程序，或者使用 go build 来直接将其编译为可执行文件。</p><p>但这种做法无疑屏蔽了太多的细节，因此我们选择先编译、后链接的“笨”方法来做：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ go tool compile <span class="token parameter variable">-p</span> main <span class="token parameter variable">-o</span> main.o main.go
$ go tool pack c main.a main.o
<span class="token comment"># internal 表示使用go内置的链接器</span>
$ go tool <span class="token function">link</span> <span class="token parameter variable">-linkmode</span><span class="token operator">=</span>internal main.a
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li>使用工具 compile 将 main.go 编译为目标文件 main.o；</li><li>使用工具 pack 将目标文件 main.o 打包为 main.a；</li><li>使用工具 link 将打包文件链接，生成可执行文件 a.out。</li></ol><p>这 3 个命令分别生成了目标文件 main.o，归档文件 main.a，以及可执行文件 a.out：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ tree <span class="token parameter variable">-L</span> <span class="token number">1</span> <span class="token builtin class-name">.</span>
<span class="token builtin class-name">.</span>
<span class="token operator">|</span>__a.out
<span class="token operator">|</span>__main.a
<span class="token operator">|</span>__main.go
<span class="token operator">|</span>__main.o
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>运行 a.out：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ ./a.out
Hello Runtime<span class="token operator">!</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>这样就展示了一个程序编译、生成到运行的全过程。</p><p>为了改变程序的入口，使其摆脱 runtime，我们可以这样做：</p><ol><li>定义一个新的函数，比如：entry；</li><li>指定链接生成可执行文件时，将 entry 作为程序入口。</li></ol><p>改造 main.go 文件，新增一个 entry 函数：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">//go:nosplit</span>
<span class="token comment">//go:noescape</span>
<span class="token keyword">func</span> <span class="token function">entry</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Hello Runtime!&quot;</span><span class="token punctuation">)</span>
	<span class="token function">entry</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里，我们没有删掉原来的代码，而是直接新增了一个 entry 函数，并在 main 函数中调用，是为了更好的展示入口函数的作用。</p><p>entry 函数体定义在一个单独的汇编文件中，如下：</p><div class="language-s line-numbers-mode" data-ext="s"><pre class="language-s"><code># linux 下
# main_linux_amd64.s
TEXT ·entry(SB), $0-0
    MOVL    $33,  DI
    MOVL    $60,  AX
    SYSCALL
    RET
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>entry 的功能也很简单，系统调用 exit 退出程序，并返回退出码 33。</p><p>由于很多使用 MAC 的同学，其对应的 entry 函数略有不同，如下：</p><div class="language-s line-numbers-mode" data-ext="s"><pre class="language-s"><code># mac 下
# main_darwin_amd64.s
TEXT ·entry(SB), $0-0
    MOVL    $33, DI
    MOVL    $(0x2000000+1), AX
    SYSCALL
    RET
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后，我们需要在链接时指定程序入口为 entry，如下：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ go tool asm <span class="token parameter variable">-gensymabis</span> <span class="token parameter variable">-o</span> symabis main_linux_amd64.s
$ go tool compile <span class="token parameter variable">-symabis</span> symabis <span class="token parameter variable">-p</span> main <span class="token parameter variable">-o</span> x1.o main.go
$ go tool asm <span class="token parameter variable">-o</span> x2.o main_linux_amd64.s
$ go tool pack c x.a x1.o x2.o
$ go tool <span class="token function">link</span> <span class="token parameter variable">-linkmode</span><span class="token operator">=</span>internal <span class="token parameter variable">-E</span> <span class="token string">&#39;main.entry&#39;</span> x.a
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li>使用 asm 工具为 main_linux_amd64.s 生成符号文件；</li><li>使用 compile 工具编译 main.go 文件，生成 x1.o 目标文件；</li><li>使用 asm 工具为 main_linux_amd64 生成目标文件 x2.o；</li><li>使用 pack 工具打包 x1.o，x2.o 并生成 x.a 归档文件；</li><li>使用 link 工具链接生成 a.out 可执行文件。</li></ol><p>go 链接器提供 E 参数来设置执行文件入口，这里我们指定 main.entry 为程序入口，这样链接生成的文件就不会再走原来的执行流，执行结果如下：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ ./a.out
$ <span class="token builtin class-name">echo</span> <span class="token variable">$?</span>
<span class="token number">33</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从运行结果来看，程序并没有调用 Println 函数，而是直接从 entry 进入，调用 exit 后退出程序，退出码为 33。</p><p>这样，程序也不会进入 rt0_go 中，不会初始化 runtime 资源，从而达到规避 runtime 的作用。</p><p>这种方式虽然不会初始化 runtime，但由于 go 编译器的默认行为，runtime 代码也会被打包进执行文件，因此笔者才没有说丢掉 runtime，而是最小化 runtime。</p><h2 id="魔法-2-即时编译-jit-just-in-time" tabindex="-1"><a class="header-anchor" href="#魔法-2-即时编译-jit-just-in-time" aria-hidden="true">#</a> 魔法 2：即时编译 JIT(just-in-time)</h2><p>目前很多脚本语言都加入了<strong>即时编译</strong>的新特性。即时编译的原理很简单，那就是在运行时生成机器码，然后执行，达到提升程序性能的效果。</p><p>Python 脚本是通过虚拟机(VM)以字节码的方式解释执行的。一个简单的字节码样例大致如下：</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">return</span> x <span class="token operator">+</span> y

<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">import</span> dis
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> dis<span class="token punctuation">.</span>dis<span class="token punctuation">(</span>add<span class="token punctuation">)</span>
  <span class="token number">2</span>           <span class="token number">0</span> LOAD_FAST                <span class="token number">0</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span>
              <span class="token number">2</span> LOAD_FAST                <span class="token number">1</span> <span class="token punctuation">(</span>y<span class="token punctuation">)</span>
              <span class="token number">4</span> BINARY_ADD
              <span class="token number">6</span> RETURN_VALUE
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里，我们定义了一个简单的 add 函数，并通过 dis 模块来查看 add 函数对应的字节码。Python 虚拟机是一个典型的栈机，其字节码执行都是基于栈来执行的，以 add 为例：</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token number">0</span> LOAD_FAST                <span class="token number">0</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span>
<span class="token number">2</span> LOAD_FAST                <span class="token number">1</span> <span class="token punctuation">(</span>y<span class="token punctuation">)</span>
<span class="token number">4</span> BINARY_ADD
<span class="token number">6</span> RETURN_VALUE
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>LOAD_FAST</strong>指令会从局部变量中拿到变量值并入栈，这里会将 x，y 入栈，然后调用 <strong>BINARY_ADD</strong> 指令将栈顶的两个值出栈、相加后将结果再入栈，最后调用 <strong>RETURN_VALUE</strong>指令将栈顶值返回。</p><p>如下图所示：</p><p><img src="`+k+`" alt="栈操作"></p><p>与直接运行机器码相比，字节码执行具有良好的跨平台性，一次编译，处处运行（装有 Python 虚拟机的前提下），但也损耗了一定的性能。</p><p>而<strong>即时编译</strong>会在程序运行时，将字节码编译为机器码运行，一定程度上补偿了这种损耗。</p><p>下面，我们就用 go 来实现一个简单的 Python JIT 编译器来领略即时编译的魅力。</p><p><strong>即时编译</strong>原理虽然简单明了，但实现却很复杂，我们只会实现一个简单的 JIT 编译器，它会将类似下面的 Python 函数即时编译为机器码，然后写入内存并执行：</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> x <span class="token operator">*</span> x <span class="token operator">-</span> y <span class="token operator">*</span> y
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>这个函数会进行简单的四则运算，并将结果返回。其对应的字节码如下：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>0 LOAD_FAST                0 (x)
2 LOAD_FAST                0 (x)
4 BINARY_MULTIPLY
6 LOAD_FAST                1 (y)
8 LOAD_FAST                1 (y)
10 BINARY_MULTIPLY
12 BINARY_SUBTRACT
14 RETURN_VALUE
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>笔者没有写代码去实现如何将 Python 代码翻译为字节码，这些编译器前端知识感兴趣的同学可以自行去查阅词法分析、语法分析等资料，或者直接去阅读 CPython 源码。</p></blockquote>`,58),g={href:"https://en.wikipedia.org/wiki/Intermediate_representation",target:"_blank",rel:"noopener noreferrer"},f=n("p",null,"很多同学会不会疑惑多此一举？其实 IR 的存在是非常有必要的，几乎所有的编译器都有 IR，甚至可能不止一种 IR，至于 IR 的作用，在后文中笔者带领大家来体会。",-1),q=n("p",null,"我们以 foo 函数为例，看看如何将其字节码翻译为 IR。foo 的第一条字节码指令：",-1),h=n("div",{class:"language-text line-numbers-mode","data-ext":"text"},[n("pre",{class:"language-text"},[n("code",null,`LOAD_FAST                0 (x)
`)]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"})])],-1),y=n("p",null,[n("code",null,"LOAD_FAST"),s("会从局部变量中拿到数据，然后推入栈，LOAD_FAST 指令附带一个参数，即后面的 0，表示第 0 个局部变量，也就是 x 参数。")],-1),_={href:"https://en.wikipedia.org/wiki/Register_allocation",target:"_blank",rel:"noopener noreferrer"},x=p(`<div class="language-S line-numbers-mode" data-ext="S"><pre class="language-S"><code>push rax
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>与绝大多数汇编一样，这里将一段内存看作一个栈来操作，push 表示入栈，即将 rax 入栈。反过来，pop 表示出栈：</p><div class="language-S line-numbers-mode" data-ext="S"><pre class="language-S"><code>pop rdi
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>这里将栈顶的值推出后，复制到 rdi。当然对于一些计算操作，比如加法：</p><div class="language-s line-numbers-mode" data-ext="s"><pre class="language-s"><code>add rdi rsi # rdi = rdi + rsi
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div>`,5),w={href:"https://en.wikipedia.org/wiki/Static_single_assignment_form",target:"_blank",rel:"noopener noreferrer"},A=p(`<p>另外，我们的 IR 指令一般都是一个操作命令，一个操作数或者两个操作数，比如：</p><div class="language-s line-numbers-mode" data-ext="s"><pre class="language-s"><code>mov rax 100
push rax
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>为了保证统一，我们将所有 IR 指令严格限制在两个操作数中，如果不足两个，则添加一个 <code>none</code>，如下；</p><div class="language-s line-numbers-mode" data-ext="s"><pre class="language-s"><code>mov rax 100
push rax none
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div>`,4),S={href:"https://en.wikipedia.org/wiki/Three-address_code",target:"_blank",rel:"noopener noreferrer"},I=p(`<blockquote><p>SSA 和 TAC 都有严格的定义，这里只做了简单说明，有兴趣的同学可以点开链接查看。</p></blockquote><p>你肯定会眼熟，这不就是汇编吗？是的，我们的终极目标是翻译成机器码，而汇编是目前对机器码最好的解释码，因此我们的 IR 差不多就是一种汇编方言(Dialect)。</p><p>由于目前我们支持的字节码比较少，我们的翻译代码也很简洁明了，如下：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Compiler<span class="token punctuation">)</span> <span class="token function">Compile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>SSA<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	ir <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>SSA<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	pushSSA <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>a <span class="token builtin">string</span><span class="token punctuation">,</span> b<span class="token punctuation">,</span> c <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		ssa <span class="token operator">:=</span> <span class="token operator">&amp;</span>SSA<span class="token punctuation">{</span>
			Action<span class="token punctuation">:</span> a<span class="token punctuation">,</span>
			Arg1<span class="token punctuation">:</span>   b<span class="token punctuation">,</span>
			Arg2<span class="token punctuation">:</span>   c<span class="token punctuation">,</span>
		<span class="token punctuation">}</span>
		ir <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>ir<span class="token punctuation">,</span> ssa<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> c<span class="token punctuation">.</span>index <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Opcodes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		op <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">switch</span> op<span class="token punctuation">.</span>Code <span class="token punctuation">{</span>
		<span class="token keyword">case</span> <span class="token string">&quot;LOAD_FAST&quot;</span><span class="token punctuation">:</span>
			<span class="token function">pushSSA</span><span class="token punctuation">(</span><span class="token string">&quot;push&quot;</span><span class="token punctuation">,</span> c<span class="token punctuation">.</span><span class="token function">variable</span><span class="token punctuation">(</span>op<span class="token punctuation">.</span>Arg<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token string">&quot;STORE_FAST&quot;</span><span class="token punctuation">:</span>
			<span class="token function">pushSSA</span><span class="token punctuation">(</span><span class="token string">&quot;pop&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rdi&quot;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
			<span class="token function">pushSSA</span><span class="token punctuation">(</span><span class="token string">&quot;move&quot;</span><span class="token punctuation">,</span> c<span class="token punctuation">.</span><span class="token function">variable</span><span class="token punctuation">(</span>op<span class="token punctuation">.</span>Arg<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;rdi&quot;</span><span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token string">&quot;LOAD_CONST&quot;</span><span class="token punctuation">:</span> <span class="token comment">// 加载立即数</span>
			<span class="token function">pushSSA</span><span class="token punctuation">(</span><span class="token string">&quot;immediate&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rdi&quot;</span><span class="token punctuation">,</span> c<span class="token punctuation">.</span>Constants<span class="token punctuation">[</span>op<span class="token punctuation">.</span>Arg<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
			<span class="token function">pushSSA</span><span class="token punctuation">(</span><span class="token string">&quot;push&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rdi&quot;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token string">&quot;BINARY_MULTIPLY&quot;</span><span class="token punctuation">:</span> <span class="token comment">// 乘法</span>
			<span class="token function">pushSSA</span><span class="token punctuation">(</span><span class="token string">&quot;pop&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rdi&quot;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
			<span class="token function">pushSSA</span><span class="token punctuation">(</span><span class="token string">&quot;pop&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rsi&quot;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
			<span class="token function">pushSSA</span><span class="token punctuation">(</span><span class="token string">&quot;imul&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rdi&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rsi&quot;</span><span class="token punctuation">)</span>
			<span class="token function">pushSSA</span><span class="token punctuation">(</span><span class="token string">&quot;push&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rdi&quot;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token string">&quot;BINARY_ADD&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;INPLACE_ADD&quot;</span><span class="token punctuation">:</span> <span class="token comment">// 加法</span>
			<span class="token function">pushSSA</span><span class="token punctuation">(</span><span class="token string">&quot;pop&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rdi&quot;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
			<span class="token function">pushSSA</span><span class="token punctuation">(</span><span class="token string">&quot;pop&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rsi&quot;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
			<span class="token function">pushSSA</span><span class="token punctuation">(</span><span class="token string">&quot;add&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rdi&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rsi&quot;</span><span class="token punctuation">)</span>
			<span class="token function">pushSSA</span><span class="token punctuation">(</span><span class="token string">&quot;push&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rdi&quot;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token string">&quot;BINARY_SUBTRACT&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;INPLACE_SUBTRACT&quot;</span><span class="token punctuation">:</span> <span class="token comment">// 减法</span>
			<span class="token function">pushSSA</span><span class="token punctuation">(</span><span class="token string">&quot;pop&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rsi&quot;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
			<span class="token function">pushSSA</span><span class="token punctuation">(</span><span class="token string">&quot;pop&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rdi&quot;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
			<span class="token function">pushSSA</span><span class="token punctuation">(</span><span class="token string">&quot;sub&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rdi&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rsi&quot;</span><span class="token punctuation">)</span>
			<span class="token function">pushSSA</span><span class="token punctuation">(</span><span class="token string">&quot;push&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rdi&quot;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token string">&quot;UNARY_NEGATIVE&quot;</span><span class="token punctuation">:</span>  <span class="token comment">// -x</span>
			<span class="token function">pushSSA</span><span class="token punctuation">(</span><span class="token string">&quot;pop&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rdi&quot;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
			<span class="token function">pushSSA</span><span class="token punctuation">(</span><span class="token string">&quot;neg&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rdi&quot;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
			<span class="token function">pushSSA</span><span class="token punctuation">(</span><span class="token string">&quot;push&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rdi&quot;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token string">&quot;RETURN_VALUE&quot;</span><span class="token punctuation">:</span>  <span class="token comment">// 返回</span>
			<span class="token function">pushSSA</span><span class="token punctuation">(</span><span class="token string">&quot;pop&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rax&quot;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
			<span class="token function">pushSSA</span><span class="token punctuation">(</span><span class="token string">&quot;ret&quot;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
		<span class="token keyword">default</span><span class="token punctuation">:</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;%s not support&quot;</span><span class="token punctuation">,</span> op<span class="token punctuation">.</span>Code<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> ir<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>Compile</code> 函数负责将字节码翻译为 IR(SSA)，借助寄存器和栈，能够很迅速的将字节码翻译为对应的 IR。</p><p>运行程序，翻译 foo 函数的字节码，可以得到如下的输出：</p><div class="language-s line-numbers-mode" data-ext="s"><pre class="language-s"><code>push rax none
push rax none
pop rdi none
pop rsi none
imul rdi rsi
push rdi none
push rbx none
push rbx none
pop rdi none
pop rsi none
imul rdi rsi
push rdi none
pop rsi none
pop rdi none
sub rdi rsi
push rdi none
pop rax none
ret none none
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到，foo 函数仅有 8 条字节码指令，但翻译为 IR 后，数量就翻倍了，而指令数量直接影响到了程序执行效率。</p><p>因此，我们加入一个简单的优化器，来优化 IR。这里不会涉及到太复杂的优化算法，我们只罗列几个简单的优化实现，比如：</p><div class="language-s line-numbers-mode" data-ext="s"><pre class="language-s"><code>push rax none
push rax none
pop rdi none
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里 push rax 明显重复了两次，也对应了两次 LOAD_FAST，但对于寄存器分配而言，这明显重复了。</p><p>另外：</p><div class="language-s line-numbers-mode" data-ext="s"><pre class="language-s"><code>push rax none
pop rdi none
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>现将 rax 的栈入栈，然后再将栈顶的值推出，并赋值给 rdi，这两个操作明显可以直接优化成一个操作：</p><div class="language-s line-numbers-mode" data-ext="s"><pre class="language-s"><code>mov rdi rax
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>这里直接将 rax 的值拷贝到 rdi 就行了。对应的优化代码如下：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">if</span> op1 <span class="token operator">==</span> <span class="token string">&quot;push&quot;</span> <span class="token operator">&amp;&amp;</span> op2 <span class="token operator">==</span> <span class="token string">&quot;pop&quot;</span> <span class="token punctuation">{</span>
    index <span class="token operator">+=</span> <span class="token number">2</span>
    <span class="token function">pushSSA</span><span class="token punctuation">(</span><span class="token string">&quot;mov&quot;</span><span class="token punctuation">,</span> a2<span class="token punctuation">,</span> a1<span class="token punctuation">)</span>
    <span class="token keyword">continue</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果出现类似 <code>mov rdi rdi</code> 这样无效的复制指令，也是可以直接优化的，对应的代码如下：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">if</span> op1 <span class="token operator">==</span> <span class="token string">&quot;mov&quot;</span> <span class="token operator">&amp;&amp;</span> a1 <span class="token operator">==</span> b1 <span class="token punctuation">{</span>
    index <span class="token operator">+=</span> <span class="token number">1</span>
    <span class="token keyword">continue</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>当然也有一些其它的优化，它们都是对多余指令、重复指令的精简，整体代码如下：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Optimize</span><span class="token punctuation">(</span>ir <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>SSA<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>SSA <span class="token punctuation">{</span>
	ret <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>SSA<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	fetch <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span>
		<span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> n <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>ir<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> ir<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">.</span>Action<span class="token punctuation">,</span>
				ir<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">.</span>Arg1<span class="token punctuation">,</span> ir<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">.</span>Arg2
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>
	pushSSA <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>a <span class="token builtin">string</span><span class="token punctuation">,</span> b<span class="token punctuation">,</span> c <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		ssa <span class="token operator">:=</span> <span class="token operator">&amp;</span>SSA<span class="token punctuation">{</span>
			Action<span class="token punctuation">:</span> a<span class="token punctuation">,</span>
			Arg1<span class="token punctuation">:</span>   b<span class="token punctuation">,</span>
			Arg2<span class="token punctuation">:</span>   c<span class="token punctuation">,</span>
		<span class="token punctuation">}</span>
		ret <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>ret<span class="token punctuation">,</span> ssa<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	index <span class="token operator">:=</span> <span class="token number">0</span>
	<span class="token keyword">for</span> index <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>ir<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		op1<span class="token punctuation">,</span> a1<span class="token punctuation">,</span> b1 <span class="token operator">:=</span> <span class="token function">fetch</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span>
		op2<span class="token punctuation">,</span> a2<span class="token punctuation">,</span> b2 <span class="token operator">:=</span> <span class="token function">fetch</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
		op3<span class="token punctuation">,</span> a3<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> <span class="token function">fetch</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> op1 <span class="token operator">==</span> <span class="token string">&quot;mov&quot;</span> <span class="token operator">&amp;&amp;</span> a1 <span class="token operator">==</span> b1 <span class="token punctuation">{</span>
			index <span class="token operator">+=</span> <span class="token number">1</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> op1 <span class="token operator">==</span> <span class="token string">&quot;mov&quot;</span> <span class="token operator">&amp;&amp;</span> op2 <span class="token operator">==</span> <span class="token string">&quot;mov&quot;</span> <span class="token operator">&amp;&amp;</span> a1 <span class="token operator">==</span> b2 <span class="token punctuation">{</span>
			index <span class="token operator">+=</span> <span class="token number">2</span>
			<span class="token function">pushSSA</span><span class="token punctuation">(</span><span class="token string">&quot;mov&quot;</span><span class="token punctuation">,</span> a2<span class="token punctuation">,</span> b1<span class="token punctuation">)</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> op1 <span class="token operator">==</span> <span class="token string">&quot;push&quot;</span> <span class="token operator">&amp;&amp;</span> op2 <span class="token operator">==</span> <span class="token string">&quot;pop&quot;</span> <span class="token punctuation">{</span>
			index <span class="token operator">+=</span> <span class="token number">2</span>
			<span class="token function">pushSSA</span><span class="token punctuation">(</span><span class="token string">&quot;mov&quot;</span><span class="token punctuation">,</span> a2<span class="token punctuation">,</span> a1<span class="token punctuation">)</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> op1 <span class="token operator">==</span> <span class="token string">&quot;push&quot;</span> <span class="token operator">&amp;&amp;</span> op3 <span class="token operator">==</span> <span class="token string">&quot;pop&quot;</span> <span class="token operator">&amp;&amp;</span>
			op2 <span class="token operator">!=</span> <span class="token string">&quot;push&quot;</span> <span class="token operator">&amp;&amp;</span> op2 <span class="token operator">!=</span> <span class="token string">&quot;pop&quot;</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> a2 <span class="token operator">!=</span> a3 <span class="token punctuation">{</span>
				index <span class="token operator">+=</span> <span class="token number">3</span>
				<span class="token function">pushSSA</span><span class="token punctuation">(</span><span class="token string">&quot;mov&quot;</span><span class="token punctuation">,</span> a3<span class="token punctuation">,</span> a1<span class="token punctuation">)</span>
				<span class="token function">pushSSA</span><span class="token punctuation">(</span>op2<span class="token punctuation">,</span> a2<span class="token punctuation">,</span> b2<span class="token punctuation">)</span>
				<span class="token keyword">continue</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		index<span class="token operator">++</span>
		<span class="token function">pushSSA</span><span class="token punctuation">(</span>op1<span class="token punctuation">,</span> a1<span class="token punctuation">,</span> b1<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> ret
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们实现了一个简单的优化器，虽然简单，但效果却很好，将字节码生成的 IR 优化后，新的 IR 如下：</p><div class="language-s line-numbers-mode" data-ext="s"><pre class="language-s"><code>mov rsi rax
mov rdi rax
imul rdi rsi
push rdi none
mov rsi rbx
mov rdi rbx
imul rdi rsi
mov rsi rdi
pop rdi none
sub rdi rsi
mov rax rdi
ret none none
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>IR 被精简了一半，大幅提高了程序运行效率。其实在这里已经体现出 IR 的强大作用，IR 具有很强的表现力，并且适合程序进行分析和优化，比起直接翻译为机器码，添加 IR 中间层是很有必要的。</p><p>得到 IR 后，我们需要将 IR 翻译为具体的机器码，这个地方的翻译是比较枯燥的，实际上就是人肉翻译，以 mov 指令为例：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>as <span class="token operator">*</span>Assembler<span class="token punctuation">)</span> <span class="token function">mov</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	as<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token number">0x48</span><span class="token punctuation">,</span> <span class="token number">0x89</span><span class="token punctuation">,</span> <span class="token number">0xc0</span><span class="token operator">|</span>as<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>as <span class="token operator">*</span>Assembler<span class="token punctuation">)</span> <span class="token function">register</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">byte</span> <span class="token punctuation">{</span>
	order <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">{</span>
		<span class="token string">&quot;rax&quot;</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
		<span class="token string">&quot;rcx&quot;</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
		<span class="token string">&quot;rdx&quot;</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
		<span class="token string">&quot;rbx&quot;</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
		<span class="token string">&quot;rsp&quot;</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
		<span class="token string">&quot;rbp&quot;</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
		<span class="token string">&quot;rsi&quot;</span><span class="token punctuation">:</span> <span class="token number">6</span><span class="token punctuation">,</span>
		<span class="token string">&quot;rdi&quot;</span><span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	enc <span class="token operator">:=</span> order<span class="token punctuation">[</span>a<span class="token punctuation">]</span>
	<span class="token keyword">if</span> b <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
		enc <span class="token operator">=</span> enc<span class="token operator">&lt;&lt;</span><span class="token number">3</span> <span class="token operator">|</span> order<span class="token punctuation">[</span>b<span class="token punctuation">]</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> enc
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>mov 指令对应的机器码实际上就是唯一的，区别在于不同的寄存器，指令的操作数会不一样，比如 rax 对应序号 0，其它操作寄存器的指令也类似于此，因此这里不做过多介绍，感兴趣的同学可以自己将程序编译为执行文件后，使用 objdump 工具来查看，整体的翻译代码如下：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>as <span class="token operator">*</span>Assembler<span class="token punctuation">)</span> <span class="token function">Assembly</span><span class="token punctuation">(</span>ir <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>SSA<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ssa <span class="token operator">:=</span> <span class="token keyword">range</span> ir <span class="token punctuation">{</span>
		name<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b <span class="token operator">:=</span> ssa<span class="token punctuation">.</span>Action<span class="token punctuation">,</span> ssa<span class="token punctuation">.</span>Arg1<span class="token punctuation">,</span> ssa<span class="token punctuation">.</span>Arg2
		<span class="token keyword">switch</span> name <span class="token punctuation">{</span>
		<span class="token keyword">case</span> <span class="token string">&quot;ret&quot;</span><span class="token punctuation">:</span>
			as<span class="token punctuation">.</span><span class="token function">ret</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token string">&quot;push&quot;</span><span class="token punctuation">:</span>
			as<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token string">&quot;pop&quot;</span><span class="token punctuation">:</span>
			as<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token string">&quot;imul&quot;</span><span class="token punctuation">:</span>
			as<span class="token punctuation">.</span><span class="token function">imul</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token string">&quot;add&quot;</span><span class="token punctuation">:</span>
			as<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token string">&quot;sub&quot;</span><span class="token punctuation">:</span>
			as<span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token string">&quot;neg&quot;</span><span class="token punctuation">:</span>
			as<span class="token punctuation">.</span><span class="token function">neg</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token string">&quot;mov&quot;</span><span class="token punctuation">:</span>
			as<span class="token punctuation">.</span><span class="token function">mov</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token string">&quot;immediate&quot;</span><span class="token punctuation">:</span>
			as<span class="token punctuation">.</span><span class="token function">immediate</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> as<span class="token punctuation">.</span>code<span class="token punctuation">[</span><span class="token punctuation">:</span>as<span class="token punctuation">.</span>index<span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>得到机器码后，JIT 的工作差不多就完成了，剩下的就是将机器码写入内存，然后执行了，如下：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	opcodes <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>py<span class="token punctuation">.</span>Opcode<span class="token punctuation">{</span> <span class="token comment">/* ... */</span> <span class="token punctuation">}</span>
	c <span class="token operator">:=</span> py<span class="token punctuation">.</span><span class="token function">NewCompiler</span><span class="token punctuation">(</span>opcodes<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token boolean">nil</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	ir<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Compile</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// ... 可根据实际的情况，来选择优化几次</span>
	ir <span class="token operator">=</span> py<span class="token punctuation">.</span><span class="token function">Optimize</span><span class="token punctuation">(</span>ir<span class="token punctuation">)</span>
	ir <span class="token operator">=</span> py<span class="token punctuation">.</span><span class="token function">Optimize</span><span class="token punctuation">(</span>ir<span class="token punctuation">)</span>
	<span class="token comment">// ....</span>
	assembler <span class="token operator">:=</span> py<span class="token punctuation">.</span><span class="token function">NewAssembler</span><span class="token punctuation">(</span><span class="token number">4096</span><span class="token punctuation">)</span>
	code <span class="token operator">:=</span> assembler<span class="token punctuation">.</span><span class="token function">Assembly</span><span class="token punctuation">(</span>ir<span class="token punctuation">)</span>
    <span class="token comment">// ...</span>
	area<span class="token punctuation">,</span> err <span class="token operator">:=</span> syscall<span class="token punctuation">.</span><span class="token function">Mmap</span><span class="token punctuation">(</span>
		<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
		<span class="token number">0</span><span class="token punctuation">,</span>
		<span class="token number">4096</span><span class="token punctuation">,</span>
		syscall<span class="token punctuation">.</span>PROT_READ<span class="token operator">|</span>syscall<span class="token punctuation">.</span>PROT_WRITE<span class="token operator">|</span>syscall<span class="token punctuation">.</span>PROT_EXEC<span class="token punctuation">,</span>
		syscall<span class="token punctuation">.</span>MAP_PRIVATE<span class="token operator">|</span>syscall<span class="token punctuation">.</span>MAP_ANON<span class="token punctuation">)</span> <span class="token comment">// linux for MAP_ANONYMOUS</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;mmap err: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> i<span class="token punctuation">,</span> by <span class="token operator">:=</span> <span class="token keyword">range</span> code <span class="token punctuation">{</span> <span class="token comment">// 选择 copy 无疑更佳</span>
		area<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> by
	<span class="token punctuation">}</span>
	<span class="token keyword">type</span> fooFunc <span class="token keyword">func</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y <span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token builtin">int64</span>
	unsafePrintFunc <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token builtin">uintptr</span><span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>area<span class="token punctuation">)</span><span class="token punctuation">)</span>
	foo <span class="token operator">:=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>fooFunc<span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unsafePrintFunc<span class="token punctuation">)</span><span class="token punctuation">)</span>
	ret <span class="token operator">:=</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里使用 mmap 映射出一段内存后，将生成的机器码写入内存，然后将其通过指针强转为函数指针，最后通过函数指针调用 foo(3,2)，得到如下结果：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token number">5</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><blockquote><p>提示一下，由于不同语言的调用约定是不一样的，go 自 1.17 使用寄存器来传参后，其参数是按照 rax, rcx, rdx 来排列的，因此如果是在其它语言下，生成的机器码是不同的。</p></blockquote><p>从结果可以发现，JIT 是成功的，一个简单的 Python JIT 编译器就这样被实现了。</p><h2 id="魔法-3-自举-bootstrap" tabindex="-1"><a class="header-anchor" href="#魔法-3-自举-bootstrap" aria-hidden="true">#</a> 魔法 3：自举(bootstrap)</h2><p>go 是自举实现的，而且是一个完全自举的编译器实现，即编译器、链接器等等都是用 go 实现的；不仅如此，go 把编译器的前端部分直接开放在了标准库中，这意味着我们不仅可以直接使用前端部分，还可以替换另外的中、后端平台来编译 go。如下：</p><p><img src="`+d+`" alt="LLVM替换"></p><p>我们借助 go 标准库和 LLVM 就能实现一个非常简单的编译器，不再使用 go 默认编译器独有的 IR 和机器码生成器。</p><p>目标很明确：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">func</span> <span class="token function">add</span><span class="token punctuation">(</span>x <span class="token builtin">int</span><span class="token punctuation">,</span> y <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> x <span class="token operator">+</span> y
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>实现一个极简编译器，将这段 go 代码编译为可执行文件即可。</p><p>首先，使用 go/parser 等标准库来等 go 源代码进行解析，如下：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fset <span class="token operator">:=</span> token<span class="token punctuation">.</span><span class="token function">NewFileSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 相对于fset的position</span>
	src <span class="token operator">:=</span> <span class="token string">\`package main

import &quot;fmt&quot;

func add(x int, y int) int {
	return x + y
}

func main() {
	fmt.Println(add(10, 2))
}\`</span>

	f<span class="token punctuation">,</span> err <span class="token operator">:=</span> parser<span class="token punctuation">.</span><span class="token function">ParseFile</span><span class="token punctuation">(</span>fset<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> src<span class="token punctuation">,</span> parser<span class="token punctuation">.</span>AllErrors<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	ast<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span>fset<span class="token punctuation">,</span> f<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>由于 go 良好的自举设计，我们可以轻松得到这段代码的 AST 树：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>0  *ast.File {
1  .  Package: 1:1
2  .  Name: *ast.Ident {
3  .  .  NamePos: 1:9
4  .  .  Name: &quot;main&quot;
5  .  }
6  .  Decls: []ast.Decl (len = 3) {
7  .  .  0: *ast.GenDecl {
8  .  .  .  TokPos: 3:1
9  .  .  .  Tok: import
.... 省略
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>LLVM 为了屏蔽不同平台架构之间的指令差异性，设计了一种 IR，举例：</p><div class="language-ll line-numbers-mode" data-ext="ll"><pre class="language-ll"><code>define i32 @add(i32 %a, i32 %b) {
  %1 = add i32 %a, %b
  ret i32 %1
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>LLVM 的 IR 不同于上面提到的汇编方言，而是一种更加高级的抽象，有基本的函数定义、分支等，更像是一种 low level C。</p><p>LLVM 的编译器 clang 是支持直接将 IR 编译为可执行文件的，在编译的过程中会自动对 IR、机器码进行优化，这也是 LLVM 近些年火爆的原因，很多语言搭上了 LLVM 的快车，比如 Rust 等。</p>`,49),R={href:"https://go.googlesource.com/gollvm/",target:"_blank",rel:"noopener noreferrer"},N={href:"https://tinygo.org/",target:"_blank",rel:"noopener noreferrer"},T=p(`<p>当然，一门语言的语法翻译也不是一件易事，感兴趣的同学可以点开 gollvm 和 tinygo 的链接看看它们是如何做的，这里笔者仅简单的翻译上面的例子。</p><p>得到 AST 树后，我们需要拿到 add、main 函数的定义，并将其翻译为 IR，如下：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> decl <span class="token operator">:=</span> <span class="token keyword">range</span> f<span class="token punctuation">.</span>Decls <span class="token punctuation">{</span>
	<span class="token keyword">if</span> fn<span class="token punctuation">,</span> ok <span class="token operator">:=</span> decl<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>ast<span class="token punctuation">.</span>FuncDecl<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
		<span class="token keyword">if</span> fn<span class="token punctuation">.</span>Name<span class="token punctuation">.</span>Name <span class="token operator">==</span> <span class="token string">&quot;add&quot;</span> <span class="token punctuation">{</span>
			<span class="token function">translateAdd</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> funcMap<span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> fn<span class="token punctuation">.</span>Name<span class="token punctuation">.</span>Name <span class="token operator">==</span> <span class="token string">&quot;main&quot;</span> <span class="token punctuation">{</span>
			<span class="token function">translateMain</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> funcMap<span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对于 add 函数，没有复杂的函数体，我们提取出参数、返回值然后生成对应的 IR 即可：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">translateAdd</span><span class="token punctuation">(</span>m <span class="token operator">*</span>ir<span class="token punctuation">.</span>Module<span class="token punctuation">,</span> decl <span class="token operator">*</span>ast<span class="token punctuation">.</span>FuncDecl<span class="token punctuation">,</span> funcMap <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>ir<span class="token punctuation">.</span>Func<span class="token punctuation">)</span> <span class="token operator">*</span>ir<span class="token punctuation">.</span>Func <span class="token punctuation">{</span>
	params <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>ir<span class="token punctuation">.</span>Param<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> field <span class="token operator">:=</span> <span class="token keyword">range</span> decl<span class="token punctuation">.</span>Type<span class="token punctuation">.</span>Params<span class="token punctuation">.</span>List <span class="token punctuation">{</span>
		paramName <span class="token operator">:=</span> field<span class="token punctuation">.</span>Names<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Name
		paramType <span class="token operator">:=</span> field<span class="token punctuation">.</span>Type<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>ast<span class="token punctuation">.</span>Ident<span class="token punctuation">)</span><span class="token punctuation">.</span>Name
		<span class="token keyword">if</span> paramType <span class="token operator">!=</span> <span class="token string">&quot;int&quot;</span> <span class="token punctuation">{</span> <span class="token comment">// 暂不支持</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>
		params <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> ir<span class="token punctuation">.</span><span class="token function">NewParam</span><span class="token punctuation">(</span>paramName<span class="token punctuation">,</span> types<span class="token punctuation">.</span>I32<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	returnType <span class="token operator">:=</span> decl<span class="token punctuation">.</span>Type<span class="token punctuation">.</span>Results<span class="token punctuation">.</span>List<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Type<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>ast<span class="token punctuation">.</span>Ident<span class="token punctuation">)</span><span class="token punctuation">.</span>Name
	<span class="token keyword">if</span> returnType <span class="token operator">!=</span> <span class="token string">&quot;int&quot;</span> <span class="token punctuation">{</span> <span class="token comment">// 暂不支持</span>
		<span class="token function">panic</span><span class="token punctuation">(</span>returnType <span class="token operator">+</span> <span class="token string">&quot; return type is not support&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	funcDefine <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">NewFunc</span><span class="token punctuation">(</span>decl<span class="token punctuation">.</span>Name<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> types<span class="token punctuation">.</span>I32<span class="token punctuation">,</span> params<span class="token operator">...</span><span class="token punctuation">)</span>
	ab <span class="token operator">:=</span> funcDefine<span class="token punctuation">.</span><span class="token function">NewBlock</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
	ab<span class="token punctuation">.</span><span class="token function">NewRet</span><span class="token punctuation">(</span>ab<span class="token punctuation">.</span><span class="token function">NewAdd</span><span class="token punctuation">(</span>funcDefine<span class="token punctuation">.</span>Params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> funcDefine<span class="token punctuation">.</span>Params<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	funcMap<span class="token punctuation">[</span>decl<span class="token punctuation">.</span>Name<span class="token punctuation">.</span>Name<span class="token punctuation">]</span> <span class="token operator">=</span> funcDefine
	<span class="token keyword">return</span> funcDefine
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>而在 main 函数中，我们不仅需要调用 add 函数，还需要调用 println 函数来打印结果，所以，我们提前定义一个 printf 内置函数，并将其加入到哈希表中方便后续查找：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// builtin</span>
printf <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">NewFunc</span><span class="token punctuation">(</span>
	<span class="token string">&quot;printf&quot;</span><span class="token punctuation">,</span>
	types<span class="token punctuation">.</span>I32<span class="token punctuation">,</span>
	ir<span class="token punctuation">.</span><span class="token function">NewParam</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> types<span class="token punctuation">.</span><span class="token function">NewPointer</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span>I8<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
printf<span class="token punctuation">.</span>Sig<span class="token punctuation">.</span>Variadic <span class="token operator">=</span> <span class="token boolean">true</span>

funcMap <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>ir<span class="token punctuation">.</span>Func<span class="token punctuation">{</span>
		<span class="token string">&quot;printf&quot;</span><span class="token punctuation">:</span> printf<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>main 函数中，需要对 add 函数的参数进行处理，如下：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">translateMain</span><span class="token punctuation">(</span>m <span class="token operator">*</span>ir<span class="token punctuation">.</span>Module<span class="token punctuation">,</span> decl <span class="token operator">*</span>ast<span class="token punctuation">.</span>FuncDecl<span class="token punctuation">,</span> funcMap <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>ir<span class="token punctuation">.</span>Func<span class="token punctuation">)</span> <span class="token operator">*</span>ir<span class="token punctuation">.</span>Func <span class="token punctuation">{</span>
	zero <span class="token operator">:=</span> constant<span class="token punctuation">.</span><span class="token function">NewInt</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span>I32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	stmt <span class="token operator">:=</span> decl<span class="token punctuation">.</span>Body<span class="token punctuation">.</span>List<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>ast<span class="token punctuation">.</span>ExprStmt<span class="token punctuation">)</span><span class="token punctuation">.</span>X<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>ast<span class="token punctuation">.</span>CallExpr<span class="token punctuation">)</span><span class="token punctuation">.</span>Args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>ast<span class="token punctuation">.</span>CallExpr<span class="token punctuation">)</span>
	args <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>value<span class="token punctuation">.</span>Value<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> item <span class="token operator">:=</span> <span class="token keyword">range</span> stmt<span class="token punctuation">.</span>Args <span class="token punctuation">{</span>
		val <span class="token operator">:=</span> item<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>ast<span class="token punctuation">.</span>BasicLit<span class="token punctuation">)</span><span class="token punctuation">.</span>Value
		i<span class="token punctuation">,</span> err <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">ParseInt</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>
		args <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> constant<span class="token punctuation">.</span><span class="token function">NewInt</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span>I32<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	funcMain <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">NewFunc</span><span class="token punctuation">(</span><span class="token string">&quot;main&quot;</span><span class="token punctuation">,</span> types<span class="token punctuation">.</span>I32<span class="token punctuation">)</span>
	mb <span class="token operator">:=</span> funcMain<span class="token punctuation">.</span><span class="token function">NewBlock</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
	result <span class="token operator">:=</span> mb<span class="token punctuation">.</span><span class="token function">NewCall</span><span class="token punctuation">(</span>funcMap<span class="token punctuation">[</span><span class="token string">&quot;add&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> args<span class="token operator">...</span><span class="token punctuation">)</span>
	formatStr <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">NewGlobalDef</span><span class="token punctuation">(</span><span class="token string">&quot;formatStr&quot;</span><span class="token punctuation">,</span> constant<span class="token punctuation">.</span><span class="token function">NewCharArrayFromString</span><span class="token punctuation">(</span><span class="token string">&quot;%d\\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	format <span class="token operator">:=</span> constant<span class="token punctuation">.</span><span class="token function">NewGetElementPtr</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span><span class="token function">NewArray</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> types<span class="token punctuation">.</span>I8<span class="token punctuation">)</span><span class="token punctuation">,</span> formatStr<span class="token punctuation">,</span> zero<span class="token punctuation">,</span> zero<span class="token punctuation">)</span>
	mb<span class="token punctuation">.</span><span class="token function">NewCall</span><span class="token punctuation">(</span>funcMap<span class="token punctuation">[</span><span class="token string">&quot;printf&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> format<span class="token punctuation">,</span> result<span class="token punctuation">)</span>
	mb<span class="token punctuation">.</span><span class="token function">NewRet</span><span class="token punctuation">(</span>zero<span class="token punctuation">)</span>
	<span class="token keyword">return</span> funcMain
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后，我们将得到的 IR 打印并写入文件，并调用 clang 编译为执行文件：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fset <span class="token operator">:=</span> token<span class="token punctuation">.</span><span class="token function">NewFileSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 相对于fset的position</span>
	src <span class="token operator">:=</span> <span class="token string">\`package main

import &quot;fmt&quot;

func add(x int, y int) int {
	return x + y
}

func main() {
	fmt.Println(add(10, 2))
}\`</span>
	f<span class="token punctuation">,</span> err <span class="token operator">:=</span> parser<span class="token punctuation">.</span><span class="token function">ParseFile</span><span class="token punctuation">(</span>fset<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> src<span class="token punctuation">,</span> parser<span class="token punctuation">.</span>AllErrors<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	m <span class="token operator">:=</span> ir<span class="token punctuation">.</span><span class="token function">NewModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// builtin</span>
	printf <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">NewFunc</span><span class="token punctuation">(</span>
		<span class="token string">&quot;printf&quot;</span><span class="token punctuation">,</span>
		types<span class="token punctuation">.</span>I32<span class="token punctuation">,</span>
		ir<span class="token punctuation">.</span><span class="token function">NewParam</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> types<span class="token punctuation">.</span><span class="token function">NewPointer</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span>I8<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">)</span>
	printf<span class="token punctuation">.</span>Sig<span class="token punctuation">.</span>Variadic <span class="token operator">=</span> <span class="token boolean">true</span>
	funcMap <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>ir<span class="token punctuation">.</span>Func<span class="token punctuation">{</span>
		<span class="token string">&quot;printf&quot;</span><span class="token punctuation">:</span> printf<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> decl <span class="token operator">:=</span> <span class="token keyword">range</span> f<span class="token punctuation">.</span>Decls <span class="token punctuation">{</span>
		<span class="token keyword">if</span> fn<span class="token punctuation">,</span> ok <span class="token operator">:=</span> decl<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>ast<span class="token punctuation">.</span>FuncDecl<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
			<span class="token keyword">if</span> fn<span class="token punctuation">.</span>Name<span class="token punctuation">.</span>Name <span class="token operator">==</span> <span class="token string">&quot;add&quot;</span> <span class="token punctuation">{</span>
				<span class="token function">translateAdd</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> funcMap<span class="token punctuation">)</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> fn<span class="token punctuation">.</span>Name<span class="token punctuation">.</span>Name <span class="token operator">==</span> <span class="token string">&quot;main&quot;</span> <span class="token punctuation">{</span>
				<span class="token function">translateMain</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> funcMap<span class="token punctuation">)</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token keyword">continue</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	err <span class="token operator">=</span> ioutil<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span><span class="token string">&quot;./add.ll&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0666</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	err <span class="token operator">=</span> exec<span class="token punctuation">.</span><span class="token function">Command</span><span class="token punctuation">(</span><span class="token string">&quot;clang&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./add.ll&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>运行程序，我们可以在命令行中看到生成的 IR：</p><div class="language-ll line-numbers-mode" data-ext="ll"><pre class="language-ll"><code>@formatStr = global [3 x i8] c&quot;%d\\0A&quot;

declare i32 @printf(i8* %0, ...)

define i32 @add(i32 %x, i32 %y) {
0:
        %1 = add i32 %x, %y
        ret i32 %1
}

define i32 @main() {
0:
        %1 = call i32 @add(i32 10, i32 2)
        %2 = call i32 (i8*, ...) @printf(i8* getelementptr ([3 x i8], [3 x i8]* @formatStr, i32 0, i32 0), i32 %1)
        ret i32 0
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>且在当前文件夹下有 a.out 可执行文件，我们尝试运行它：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ ./a.out
<span class="token number">12</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>至此，一个极简的 go 自举编译器就实现了，我们也顺利得到了正确的结果。</p><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h2><p>很明显，本文内容与编译器强相关，编译器是一个极其有意思的主题，希望本文能带给你一个新的编译器视角，然后去学习、实践它。</p><p>体验不一样的乐趣。</p><h2 id="参考资料" tabindex="-1"><a class="header-anchor" href="#参考资料" aria-hidden="true">#</a> 参考资料</h2>`,20),L={href:"https://github.com/golang/go",target:"_blank",rel:"noopener noreferrer"},P={href:"https://github.com/gopher-os/gopher-os",target:"_blank",rel:"noopener noreferrer"},D={href:"https://github.com/icexin/eggos",target:"_blank",rel:"noopener noreferrer"},M={href:"https://xargin.com/go1-17-new-calling-convention/",target:"_blank",rel:"noopener noreferrer"},E={href:"https://csl.name/post/python-compiler/",target:"_blank",rel:"noopener noreferrer"},F={href:"https://en.wikipedia.org/wiki/Exit_(system_call)",target:"_blank",rel:"noopener noreferrer"},O={href:"https://tinygo.org/",target:"_blank",rel:"noopener noreferrer"},C={href:"https://github.com/llir/llvm",target:"_blank",rel:"noopener noreferrer"};function V(B,$){const o=e("RouterLink"),t=e("ExternalLinkIcon");return i(),l("div",null,[m,n("p",null,[s("在上一篇"),a(o,{to:"/posts/go/magic.html"},{default:u(()=>[s("文章")]),_:1}),s("中，笔者分享了 go 中两个有意思的技巧。")]),b,n("p",null,[s("想要将字节码直接翻译为机器码可不简单，我们需引入"),n("a",g,[s("中间代码"),a(t)]),s("（IR，Intermediate Representation），即先将字节码翻译为 IR，然后再将 IR 翻译为机器码。")]),f,q,h,y,n("p",null,[s("使用"),n("a",_,[s("寄存器"),a(t)]),s("来暂存局部变量，我们可以设计出类似下面的 IR：")]),x,n("p",null,[s("会将两个寄存器的值相加后再置入第一个寄存器中。每一个指令只做一件小事情，比如赋值、四则运算等等，类似这样的 IR 指令称为"),n("a",w,[s("SSA"),a(t)]),s("。")]),A,n("p",null,[s("这样的指令形式被称为 "),n("a",S,[s("Three-address code(TAC)"),a(t)]),s("。")]),I,n("p",null,[s("所以，任务更加简单了，只需要在 AST 树翻译为 LLVM IR 即可。实际上，有一些项目就是采用这种做法，比如 "),n("a",R,[s("gollvm"),a(t)]),s("和 "),n("a",N,[s("tinygo"),a(t)]),s(" 等。")]),T,n("ul",null,[n("li",null,[n("a",L,[s("go"),a(t)])]),n("li",null,[n("a",P,[s("gopher-os"),a(t)])]),n("li",null,[n("a",D,[s("eggos"),a(t)])]),n("li",null,[n("a",M,[s("Go 1.17 的新调用规约"),a(t)])]),n("li",null,[n("a",E,[s("JIT compiling a subset of Python to x86-64"),a(t)])]),n("li",null,[n("a",F,[s("Exit_(system_call)"),a(t)])]),n("li",null,[n("a",O,[s("tinygo"),a(t)])]),n("li",null,[n("a",C,[s("llir"),a(t)])])])])}const G=c(v,[["render",V],["__file","magic2.html.vue"]]);export{G as default};

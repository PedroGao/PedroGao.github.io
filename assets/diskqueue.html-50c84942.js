import{_ as n}from"./plugin-vue_export-helper-c27b6911.js";import{r as u,o,c as p,f as r,a as i,b as l,e as t}from"./app-4eb79304.js";const a="/assets/diskqueue1-f3b83ad8.png",d="/assets/diskqueue2-1e4d4f87.png",m="/assets/diskqueue3-d2422c11.png",k="/assets/diskqueue4-e00d0af6.png",q="/assets/diskqueue5-e737a278.png",g="/assets/diskqueue6-41335435.png",f="/assets/diskqueue7-44570cd1.png",b="/assets/diskqueue8-513e38dc.png",x="/assets/diskqueue9-beb8247f.png",_="/assets/diskqueue10-4b74337e.png",h="/assets/diskqueue11-f322adde.png",v={},y={href:"https://github.com/pedrogao/tinymq/tree/main/examples/dqv1",target:"_blank",rel:"noopener noreferrer"},F={href:"https://github.com/pedrogao/tinymq/tree/main/examples/dqv2",target:"_blank",rel:"noopener noreferrer"},N={href:"https://github.com/pedrogao/tinymq/tree/main/examples/dqv3",target:"_blank",rel:"noopener noreferrer"},w={href:"https://github.com/pedrogao/tinymq/tree/main/diskqueue",target:"_blank",rel:"noopener noreferrer"};function M(O,e){const s=u("ExternalLinkIcon");return o(),p("div",null,[e[8]||(e[8]=r('<blockquote><p>一步一步推导演进持久化磁盘队列的设计与实现。<br> 在方向不明确，不够熟练的情况下，从 demo 做起，一步步学习先进的设计理念并付诸行动。</p></blockquote><hr><h2 id="第一版-单文件持久化队列" tabindex="-1"><a class="header-anchor" href="#第一版-单文件持久化队列" aria-hidden="true">#</a> 第一版，单文件持久化队列</h2><ul><li>元数据、堆数据存储在一个文件中；</li><li>元数据：记录读、写消费指针，队列大小；</li><li>堆数据：item 长度、数据；</li><li>元数据 + 堆数据单文件存储；</li></ul><p><img src="'+a+'" alt="diskqueue1"></p><p>UML 类图：</p><p><img src="'+d+'" alt="diskqueue2"></p><p>读：</p><p><img src="'+m+'" alt="diskqueue3"></p><p>写：</p><p><img src="'+k+'" alt="diskqueue4"></p>',11)),i("p",null,[e[1]||(e[1]=l("实现参考")),i("a",y,[e[0]||(e[0]=l("dqv1")),t(s)])]),e[9]||(e[9]=i("hr",null,null,-1)),e[10]||(e[10]=i("h2",{id:"第二版-多文件持久化队列",tabindex:"-1"},[i("a",{class:"header-anchor",href:"#第二版-多文件持久化队列","aria-hidden":"true"},"#"),l(" 第二版，多文件持久化队列")],-1)),e[11]||(e[11]=i("ul",null,[i("li",null,"元数据、堆数据存储在不同文件中；"),i("li",null,"元数据：记录读、写消费指针，队列大小；"),i("li",null,"堆数据：item 长度、数据；"),i("li",null,"元数据 + 堆数据单文件存储；")],-1)),e[12]||(e[12]=i("p",null,[i("img",{src:q,alt:"diskqueue5"})],-1)),e[13]||(e[13]=i("p",null,[i("img",{src:g,alt:"diskqueue6"})],-1)),i("p",null,[e[3]||(e[3]=l("实现参考")),i("a",F,[e[2]||(e[2]=l("dqv2")),t(s)])]),e[14]||(e[14]=r('<p>diskqueue：</p><ul><li>fields： <ul><li>size：队列大小；</li><li>readPos：读偏移；</li><li>writePos：写偏移；</li><li>readFileNum：读文件序号；</li><li>writeFileNum：写文件序号；</li><li>nextReadPos：下一次读文件偏移；</li><li>nextReadFileNum：下一次读文件序号；</li><li>name：队列名称；</li><li>path：数据存储路径；</li><li>maxBytesPerFile：文件最大字节数；</li><li>maxBytesFileRead：文件最大可读字节数；</li><li>syncThreshold：刷盘次数阈值；</li><li>syncTimeout：刷盘间隔；</li></ul></li><li>methods： <ul><li>open：（重新）打开队列；</li><li>readMetadata：读元数据；</li><li>writeMetadata：写元数据；</li><li>writeOne：写一条消息；</li><li>readOne：读一条消息；</li><li>sync：刷盘，元数据文件、写文件；</li></ul></li></ul><p>diskqueue open：</p><p><img src="'+f+'" alt="diskqueue7"></p><p>diskqueue readMetadata：</p><p><img src="'+b+'" alt="diskqueue8"></p><p>diskqueue writeMetadata：</p><p><img src="'+x+'" alt="diskqueue9"></p><p>diskqueue readOne：</p><p><img src="'+_+'" alt="diskqueue10"></p><p>readOne 需要同时支持 peek 和 poll，peek 不会更新 readPos、readFileNum、size，因此 readOne 也不会更新，但 poll 会更新。</p><p>diskqueue writeOne：</p><p><img src="'+h+'" alt="diskqueue11"></p>',13)),i("p",null,[e[5]||(e[5]=l("实现参考")),i("a",N,[e[4]||(e[4]=l("dqv3")),t(s)])]),e[15]||(e[15]=r('<p>优化点：</p><ol><li>刷盘策略：</li><li>刷盘线程，频率可配置</li><li>时间戳：</li><li>按时间清除数据</li><li>Page 读取：</li><li>HeapFile、MetaFile 按照页组织</li><li>Cache 策略：</li><li>增加读、写命中率</li></ol><hr><h2 id="第三版-多消费者-fanout-持久化队列" tabindex="-1"><a class="header-anchor" href="#第三版-多消费者-fanout-持久化队列" aria-hidden="true">#</a> 第三版，多消费者（Fanout）持久化队列</h2><ul><li>元数据、堆数据存储在不同文件中；</li><li>元数据：记录多个消费者读、写消费指针，队列大小；</li><li>堆数据：item 长度、数据；</li><li>元数据 + 堆数据单文件存储；</li></ul>',5)),i("p",null,[e[7]||(e[7]=l("实现参考")),i("a",w,[e[6]||(e[6]=l("diskqueue")),t(s)])])])}const V=n(v,[["render",M],["__file","diskqueue.html.vue"]]);export{V as default};

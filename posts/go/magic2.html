<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.46" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://pedrogao.github.io/posts/go/magic2.html"><meta property="og:site_name" content="廊中别苑"><meta property="og:title" content="go 另外几个黑魔法技巧"><meta property="og:type" content="article"><meta property="og:updated_time" content="2022-05-29T08:00:33.000Z"><meta property="og:locale" content="zh-CN"><meta property="article:tag" content="go"><meta property="article:tag" content="magic"><meta property="article:published_time" content="2022-03-28T00:00:00.000Z"><meta property="article:modified_time" content="2022-05-29T08:00:33.000Z"><title>go 另外几个黑魔法技巧 | 廊中别苑</title><meta name="description" content="我们不是在这里开发一些实用的东西，我们纯粹是为了学习而选择挑战。">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d2025;
      }

      html,
      body {
        background-color: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.querySelector("html").setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="stylesheet" href="/assets/style.1b50cf03.css">
    <link rel="modulepreload" href="/assets/app.7136131a.js"><link rel="modulepreload" href="/assets/magic2.html.29d93f2f.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper.21dcd24c.js"><link rel="modulepreload" href="/assets/magic2.html.ebb64ac5.js"><link rel="prefetch" href="/assets/index.html.39268b30.js"><link rel="prefetch" href="/assets/home.html.d5f6de1c.js"><link rel="prefetch" href="/assets/slide.html.a6a0f95a.js"><link rel="prefetch" href="/assets/transaction.html.14870e8c.js"><link rel="prefetch" href="/assets/raft.html.80bb3e63.js"><link rel="prefetch" href="/assets/tiny-react.html.6989a15e.js"><link rel="prefetch" href="/assets/generics.html.b497d730.js"><link rel="prefetch" href="/assets/helloworld.html.97ee3de2.js"><link rel="prefetch" href="/assets/magic.html.7ae16a84.js"><link rel="prefetch" href="/assets/plan9.html.c638576e.js"><link rel="prefetch" href="/assets/pool.html.a7981fb4.js"><link rel="prefetch" href="/assets/tcp-impl.html.cba8e00f.js"><link rel="prefetch" href="/assets/404.html.a4eb062d.js"><link rel="prefetch" href="/assets/index.html.981552cf.js"><link rel="prefetch" href="/assets/index.html.1beb2df9.js"><link rel="prefetch" href="/assets/index.html.d8ca69b0.js"><link rel="prefetch" href="/assets/index.html.59956f0e.js"><link rel="prefetch" href="/assets/index.html.04e9193a.js"><link rel="prefetch" href="/assets/index.html.b9a3c573.js"><link rel="prefetch" href="/assets/index.html.d1c8538c.js"><link rel="prefetch" href="/assets/index.html.eb5cd08c.js"><link rel="prefetch" href="/assets/index.html.c0b0c8ed.js"><link rel="prefetch" href="/assets/index.html.72698def.js"><link rel="prefetch" href="/assets/index.html.8c012c28.js"><link rel="prefetch" href="/assets/index.html.d9618f83.js"><link rel="prefetch" href="/assets/index.html.793aca96.js"><link rel="prefetch" href="/assets/index.html.290a5546.js"><link rel="prefetch" href="/assets/index.html.2f39c101.js"><link rel="prefetch" href="/assets/index.html.611f9f9d.js"><link rel="prefetch" href="/assets/index.html.bfa74582.js"><link rel="prefetch" href="/assets/index.html.55104804.js"><link rel="prefetch" href="/assets/index.html.ea770a33.js"><link rel="prefetch" href="/assets/index.html.acd0226e.js"><link rel="prefetch" href="/assets/index.html.6497dc23.js"><link rel="prefetch" href="/assets/index.html.91709f56.js"><link rel="prefetch" href="/assets/index.html.d0644252.js"><link rel="prefetch" href="/assets/index.html.d013e215.js"><link rel="prefetch" href="/assets/index.html.b9a96727.js"><link rel="prefetch" href="/assets/index.html.11783449.js"><link rel="prefetch" href="/assets/home.html.d48e5781.js"><link rel="prefetch" href="/assets/slide.html.768c8352.js"><link rel="prefetch" href="/assets/transaction.html.94bc941b.js"><link rel="prefetch" href="/assets/raft.html.537cf450.js"><link rel="prefetch" href="/assets/tiny-react.html.013f5089.js"><link rel="prefetch" href="/assets/generics.html.f0d4397d.js"><link rel="prefetch" href="/assets/helloworld.html.18d64254.js"><link rel="prefetch" href="/assets/magic.html.77f2ebad.js"><link rel="prefetch" href="/assets/plan9.html.daa3f71d.js"><link rel="prefetch" href="/assets/pool.html.7c215752.js"><link rel="prefetch" href="/assets/tcp-impl.html.816ac644.js"><link rel="prefetch" href="/assets/404.html.521c2893.js"><link rel="prefetch" href="/assets/index.html.c578bdd6.js"><link rel="prefetch" href="/assets/index.html.edfdcf07.js"><link rel="prefetch" href="/assets/index.html.9063bbd6.js"><link rel="prefetch" href="/assets/index.html.cb4ef502.js"><link rel="prefetch" href="/assets/index.html.6f6e593c.js"><link rel="prefetch" href="/assets/index.html.abd95a52.js"><link rel="prefetch" href="/assets/index.html.d3e696d5.js"><link rel="prefetch" href="/assets/index.html.5b277fd3.js"><link rel="prefetch" href="/assets/index.html.e2d11bd8.js"><link rel="prefetch" href="/assets/index.html.efbdc4c6.js"><link rel="prefetch" href="/assets/index.html.a86d39b3.js"><link rel="prefetch" href="/assets/index.html.78af9635.js"><link rel="prefetch" href="/assets/index.html.a4e211cd.js"><link rel="prefetch" href="/assets/index.html.4f2599f6.js"><link rel="prefetch" href="/assets/index.html.7c41bc24.js"><link rel="prefetch" href="/assets/index.html.a423afb9.js"><link rel="prefetch" href="/assets/index.html.a3e12eee.js"><link rel="prefetch" href="/assets/index.html.cf3c18a9.js"><link rel="prefetch" href="/assets/index.html.f0c4a02b.js"><link rel="prefetch" href="/assets/index.html.193818f2.js"><link rel="prefetch" href="/assets/index.html.33bd2149.js"><link rel="prefetch" href="/assets/index.html.79a8d4b7.js"><link rel="prefetch" href="/assets/index.html.282f965f.js"><link rel="prefetch" href="/assets/index.html.3fabf03a.js"><link rel="prefetch" href="/assets/index.html.57b390d2.js"><link rel="prefetch" href="/assets/404.068d0583.js"><link rel="prefetch" href="/assets/Layout.1896eb72.js"><link rel="prefetch" href="/assets/Slide.5fa36817.js"><link rel="prefetch" href="/assets/Blog.1ce203c3.js"><link rel="prefetch" href="/assets/auto.esm.36809f22.js"><link rel="prefetch" href="/assets/index.308e684a.js"><link rel="prefetch" href="/assets/index.1842ee54.js"><link rel="prefetch" href="/assets/mermaid.esm.min.95aabeb7.js"><link rel="prefetch" href="/assets/highlight.esm.d982e650.js"><link rel="prefetch" href="/assets/markdown.esm.832a189d.js"><link rel="prefetch" href="/assets/math.esm.a3f84b6f.js"><link rel="prefetch" href="/assets/notes.esm.3c361cb7.js"><link rel="prefetch" href="/assets/reveal.esm.b96f05d8.js"><link rel="prefetch" href="/assets/search.esm.80da4a02.js"><link rel="prefetch" href="/assets/zoom.esm.8514a202.js"><link rel="prefetch" href="/assets/photoswipe.esm.92018b73.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">Skip to content</a><!--]--><div class="theme-container has-toc"><!--[--><!--[--><header class="navbar"><div class="navbar-left"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!----><a href="/" class="brand"><img class="logo" src="/photo.jpg" alt="廊中别苑"><!----><span class="site-name hide-in-pad">廊中别苑</span></a><!----></div><div class="navbar-center"><!----><nav class="nav-links"><div class="nav-item hide-in-mobile"><a href="/" class="nav-link" aria-label="廊中别苑"><span class="icon iconfont icon-home" style=""></span>廊中别苑<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="归档"><span class="title"><span class="icon iconfont icon-edit" style=""></span>归档</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>go</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/posts/go/helloworld.html" class="nav-link" aria-label="从 Hello World 来看看 go 的运行流程"><span class="icon iconfont icon-edit" style=""></span>从 Hello World 来看看 go 的运行流程<!----></a></li><li class="dropdown-subitem"><a href="/posts/go/plan9.html" class="nav-link" aria-label="go 汇编简单入门"><span class="icon iconfont icon-edit" style=""></span>go 汇编简单入门<!----></a></li><li class="dropdown-subitem"><a href="/posts/go/generics.html" class="nav-link" aria-label="go 泛型尝鲜，实现一个流式处理库"><span class="icon iconfont icon-edit" style=""></span>go 泛型尝鲜，实现一个流式处理库<!----></a></li><li class="dropdown-subitem"><a href="/posts/go/pool.html" class="nav-link" aria-label="go pool 池化学习、实践总结"><span class="icon iconfont icon-edit" style=""></span>go pool 池化学习、实践总结<!----></a></li><li class="dropdown-subitem"><a href="/posts/go/magic.html" class="nav-link" aria-label="go 的两个黑魔法技巧"><span class="icon iconfont icon-edit" style=""></span>go 的两个黑魔法技巧<!----></a></li><li class="dropdown-subitem"><a aria-current="page" href="/posts/go/magic2.html" class="router-link-active router-link-exact-active nav-link active" aria-label="go 另外几个黑魔法技巧"><span class="icon iconfont icon-edit" style=""></span>go 另外几个黑魔法技巧<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>network</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/posts/network/tcp-impl.html" class="nav-link" aria-label="谈谈用户态 TCP 协议实现"><span class="icon iconfont icon-edit" style=""></span>谈谈用户态 TCP 协议实现<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>distribute</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/posts/distribute/raft.html" class="nav-link" aria-label="谈谈 Raft 分布式共识性算法的实现"><span class="icon iconfont icon-edit" style=""></span>谈谈 Raft 分布式共识性算法的实现<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>frontend</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/posts/frontend/tiny-react.html" class="nav-link" aria-label="极简 React 设计与实现"><span class="icon iconfont icon-edit" style=""></span>极简 React 设计与实现<!----></a></li></ul></li></ul></button></div></div></nav><!----></div><div class="navbar-right"><!----><div class="nav-item"><!----></div><div class="nav-item"><a class="repo-link" href="https://github.com/pedrogao/pedrogao.github.io" target="_blank" rel="noopener noreferrer"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!----><!----><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow left"></span></div><aside class="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><!--[--><a href="/" class="nav-link sidebar-link sidebar-page" aria-label="廊中别苑"><span class="icon iconfont icon-home" style=""></span>廊中别苑<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><section class="sidebar-group"><p class="sidebar-heading active"><span class="icon iconfont icon-note" style=""></span><span class="title">文章</span><!----></p><ul class="sidebar-links"><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable active"><span class="icon iconfont icon-note" style=""></span><span class="title">go</span><span class="arrow down"></span></button><ul class="sidebar-links"><li><!--[--><a href="/posts/go/helloworld.html" class="nav-link sidebar-link sidebar-page" aria-label="从 Hello World 来看看 go 的运行流程"><span class="icon iconfont icon-edit" style=""></span>从 Hello World 来看看 go 的运行流程<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/posts/go/plan9.html" class="nav-link sidebar-link sidebar-page" aria-label="go 汇编简单入门"><span class="icon iconfont icon-edit" style=""></span>go 汇编简单入门<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/posts/go/generics.html" class="nav-link sidebar-link sidebar-page" aria-label="go 泛型尝鲜，实现一个流式处理库"><span class="icon iconfont icon-edit" style=""></span>go 泛型尝鲜，实现一个流式处理库<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/posts/go/pool.html" class="nav-link sidebar-link sidebar-page" aria-label="go pool 池化学习、实践总结"><span class="icon iconfont icon-edit" style=""></span>go pool 池化学习、实践总结<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/posts/go/magic.html" class="nav-link sidebar-link sidebar-page" aria-label="go 的两个黑魔法技巧"><span class="icon iconfont icon-edit" style=""></span>go 的两个黑魔法技巧<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-current="page" href="/posts/go/magic2.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" aria-label="go 另外几个黑魔法技巧"><span class="icon iconfont icon-edit" style=""></span>go 另外几个黑魔法技巧<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/posts/go/magic2.html#魔法-1-最小化运行时-minimal-runtime" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="魔法 1：最小化运行时(minimal runtime)"><!---->魔法 1：最小化运行时(minimal runtime)<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/posts/go/magic2.html#魔法-2-即时编译-jit-just-in-time" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="魔法 2：即时编译 JIT(just-in-time)"><!---->魔法 2：即时编译 JIT(just-in-time)<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/posts/go/magic2.html#魔法-3-自举-bootstrap" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="魔法 3：自举(bootstrap)"><!---->魔法 3：自举(bootstrap)<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/posts/go/magic2.html#总结" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="总结"><!---->总结<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/posts/go/magic2.html#参考资料" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="参考资料"><!---->参考资料<!----></a><ul class="sidebar-sub-headers"></ul></li></ul><!--]--></li></ul></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-note" style=""></span><span class="title">network</span><span class="arrow right"></span></button><!----></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-note" style=""></span><span class="title">distribute</span><span class="arrow right"></span></button><!----></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-note" style=""></span><span class="title">frontend</span><span class="arrow right"></span></button><!----></section><!--]--></li></ul></section><!--]--></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><span class="icon iconfont icon-edit" style=""></span>go 另外几个黑魔法技巧</h1><div class="page-info"><span class="author-info" aria-label="作者🖊" data-balloon-pos="down" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="author-item" href="https://github.com/pedrogao/" target="_blank" rel="noopener noreferrer">pedrogao</a></span><span property="author" content="pedrogao"></span></span><!----><span class="date-info" aria-label="写作日期📅" data-balloon-pos="down" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span>2022年3月28日</span><meta property="datePublished" content="2022-03-28T00:00:00.000Z"></span><span class="category-info" aria-label="分类🌈" data-balloon-pos="down" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="category icon"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><ul class="categories-wrapper"><li class="category category2 clickable" role="navigation">go</li><meta property="articleSection" content="go"></ul></span><span aria-label="标签🏷" data-balloon-pos="down" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="tag icon"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><ul class="tags-wrapper"><li class="tag tag2 clickable" role="navigation">go</li><li class="tag tag8 clickable" role="navigation">magic</li></ul><meta property="keywords" content="go,magic"></span><span class="reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="down" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 18 分钟</span><meta property="timeRequired" content="PT18M"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><div class="toc-header">此页内容</div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/posts/go/magic2.html#魔法-1-最小化运行时-minimal-runtime" class="router-link-active router-link-exact-active toc-link level2">魔法 1：最小化运行时(minimal runtime)</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/go/magic2.html#魔法-2-即时编译-jit-just-in-time" class="router-link-active router-link-exact-active toc-link level2">魔法 2：即时编译 JIT(just-in-time)</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/go/magic2.html#魔法-3-自举-bootstrap" class="router-link-active router-link-exact-active toc-link level2">魔法 3：自举(bootstrap)</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/go/magic2.html#总结" class="router-link-active router-link-exact-active toc-link level2">总结</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/posts/go/magic2.html#参考资料" class="router-link-active router-link-exact-active toc-link level2">参考资料</a></li><!----><!--]--></ul></div></aside></div><!----><div class="theme-hope-content"><h1 id="go-另外几个黑魔法技巧" tabindex="-1"><a class="header-anchor" href="#go-另外几个黑魔法技巧" aria-hidden="true">#</a> go 另外几个黑魔法技巧</h1><p>在上一篇<a href="/posts/go/magic.html" class="">文章</a>中，笔者分享了 go 中两个有意思的技巧。</p><p>而最近一段时间，笔者重新梳理了一下 go 知识点，并深入地看看了它的源码，在实践中又有了新的沉淀，于是写下这篇文章和大家分享一下。</p><h2 id="魔法-1-最小化运行时-minimal-runtime" tabindex="-1"><a class="header-anchor" href="#魔法-1-最小化运行时-minimal-runtime" aria-hidden="true">#</a> 魔法 1：最小化运行时(minimal runtime)</h2><p>我们知道，go 有一层很重的运行时(runtime)，包括内存管理、goroutine 调度等重要组件；这些组件极大地方便了应用程序的开发和迭代，但也带来了一些问题，比如：</p><ul><li>Go 程序自动接管了内存，并自带 GC，使我们无法直接操纵内存；</li><li>Go 程序自动化了内存、调度等重要模块，但这些组件本身就占用了一定资源；</li><li>.....</li></ul><p>对于应用程序而言，runtime 是良药，能够很大程度上简化机械工作，让开发者集中于核心业务开发和迭代上，但对于一些其它场景，比如操作系统，那么 runtime 会严重破坏其核心资源管理能力，那么有没有方案能让 go 摆脱掉 runtime 的束缚，使其成为一个真正的系统级编程语言呢？</p><p>肯定是有的，任何一个可执行文件而言，本质上都是目标文件被链接后生成的（以下均以 Linux 作为实践平台）。</p><p>go 编译器默认编译生成的文件，其程序的入口是 runtime 包中的 <code>_rt0_amd64_linux</code> 函数：</p><div class="language-s ext-s line-numbers-mode"><pre class="language-s"><code>TEXT _rt0_amd64_linux(SB),NOSPLIT,$-8
	JMP	_rt0_amd64(SB)

TEXT _rt0_amd64(SB),NOSPLIT,$-8
	MOVQ	0(SP), DI	// argc
	LEAQ	8(SP), SI	// argv
	JMP	runtime·rt0_go(SB)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>经 _rt0_amd64_linux 入口跳转到 _rt0_amd64、 rt0_go；在 rt0_go 中，go 程序会初始化一系列的内存、调度、GC 等资源，如下图所示：</p><p><img src="/imgs/go初始化流程图.png" alt="go初始化流程图.png" loading="lazy"></p><p>每个 go 程序都会走这么一遭，这也是其 runtime 很重的原因；想要规避掉 runtime，那么最好的方法肯定是从根源入手，将程序入口 _rt0_amd64_linux 换掉，不再进入 rt0_go 函数，也就不会初始化 runtime，那么自然就能摆脱掉 runtime。</p><p>既然有了正确的思路，那么实现起来也就不会难了。</p><p>首先，我们从一个简单的 <code>Hello Runtime!</code> 入手：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// ....</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Hello Runtime!&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>绝大多数情况下，我们会选择 go run 来运行这个简单的程序，或者使用 go build 来直接将其编译为可执行文件。</p><p>但这种做法无疑屏蔽了太多的细节，因此我们选择先编译、后链接的“笨”方法来做：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ go tool compile -p main -o main.o main.go
$ go tool pack c main.a main.o
<span class="token comment"># internal 表示使用go内置的链接器</span>
$ go tool <span class="token function">link</span> -linkmode<span class="token operator">=</span>internal main.a
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li>使用工具 compile 将 main.go 编译为目标文件 main.o；</li><li>使用工具 pack 将目标文件 main.o 打包为 main.a；</li><li>使用工具 link 将打包文件链接，生成可执行文件 a.out。</li></ol><p>这 3 个命令分别生成了目标文件 main.o，归档文件 main.a，以及可执行文件 a.out：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ tree -L <span class="token number">1</span> <span class="token builtin class-name">.</span>
<span class="token builtin class-name">.</span>
<span class="token operator">|</span>__a.out
<span class="token operator">|</span>__main.a
<span class="token operator">|</span>__main.go
<span class="token operator">|</span>__main.o
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>运行 a.out：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ ./a.out
Hello Runtime<span class="token operator">!</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>这样就展示了一个程序编译、生成到运行的全过程。</p><p>为了改变程序的入口，使其摆脱 runtime，我们可以这样做：</p><ol><li>定义一个新的函数，比如：entry；</li><li>指定链接生成可执行文件时，将 entry 作为程序入口。</li></ol><p>改造 main.go 文件，新增一个 entry 函数：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">//go:nosplit</span>
<span class="token comment">//go:noescape</span>
<span class="token keyword">func</span> <span class="token function">entry</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Hello Runtime!&quot;</span><span class="token punctuation">)</span>
	<span class="token function">entry</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里，我们没有删掉原来的代码，而是直接新增了一个 entry 函数，并在 main 函数中调用，是为了更好的展示入口函数的作用。</p><p>entry 函数体定义在一个单独的汇编文件中，如下：</p><div class="language-s ext-s line-numbers-mode"><pre class="language-s"><code># linux 下
# main_linux_amd64.s
TEXT ·entry(SB), $0-0
    MOVL    $33,  DI
    MOVL    $60,  AX
    SYSCALL
    RET
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>entry 的功能也很简单，系统调用 exit 退出程序，并返回退出码 33。</p><p>由于很多使用 MAC 的同学，其对应的 entry 函数略有不同，如下：</p><div class="language-s ext-s line-numbers-mode"><pre class="language-s"><code># mac 下
# main_darwin_amd64.s
TEXT ·entry(SB), $0-0
    MOVL    $33, DI
    MOVL    $(0x2000000+1), AX
    SYSCALL
    RET
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后，我们需要在链接时指定程序入口为 entry，如下：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ go tool asm -gensymabis -o symabis main_linux_amd64.s
$ go tool compile -symabis symabis -p main -o x1.o main.go
$ go tool asm -o x2.o main_linux_amd64.s
$ go tool pack c x.a x1.o x2.o
$ go tool <span class="token function">link</span> -linkmode<span class="token operator">=</span>internal -E <span class="token string">&#39;main.entry&#39;</span> x.a
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li>使用 asm 工具为 main_linux_amd64.s 生成符号文件；</li><li>使用 compile 工具编译 main.go 文件，生成 x1.o 目标文件；</li><li>使用 asm 工具为 main_linux_amd64 生成目标文件 x2.o；</li><li>使用 pack 工具打包 x1.o，x2.o 并生成 x.a 归档文件；</li><li>使用 link 工具链接生成 a.out 可执行文件。</li></ol><p>go 链接器提供 E 参数来设置执行文件入口，这里我们指定 main.entry 为程序入口，这样链接生成的文件就不会再走原来的执行流，执行结果如下：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ ./a.out
$ <span class="token builtin class-name">echo</span> <span class="token variable">$?</span>
<span class="token number">33</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从运行结果来看，程序并没有调用 Println 函数，而是直接从 entry 进入，调用 exit 后退出程序，退出码为 33。</p><p>这样，程序也不会进入 rt0_go 中，不会初始化 runtime 资源，从而达到规避 runtime 的作用。</p><p>这种方式虽然不会初始化 runtime，但由于 go 编译器的默认行为，runtime 代码也会被打包进执行文件，因此笔者才没有说丢掉 runtime，而是最小化 runtime。</p><h2 id="魔法-2-即时编译-jit-just-in-time" tabindex="-1"><a class="header-anchor" href="#魔法-2-即时编译-jit-just-in-time" aria-hidden="true">#</a> 魔法 2：即时编译 JIT(just-in-time)</h2><p>目前很多脚本语言都加入了<strong>即时编译</strong>的新特性。即时编译的原理很简单，那就是在运行时生成机器码，然后执行，达到提升程序性能的效果。</p><p>Python 脚本是通过虚拟机(VM)以字节码的方式解释执行的。一个简单的字节码样例大致如下：</p><div class="language-python ext-py line-numbers-mode"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">return</span> x <span class="token operator">+</span> y

<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">import</span> dis
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> dis<span class="token punctuation">.</span>dis<span class="token punctuation">(</span>add<span class="token punctuation">)</span>
  <span class="token number">2</span>           <span class="token number">0</span> LOAD_FAST                <span class="token number">0</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span>
              <span class="token number">2</span> LOAD_FAST                <span class="token number">1</span> <span class="token punctuation">(</span>y<span class="token punctuation">)</span>
              <span class="token number">4</span> BINARY_ADD
              <span class="token number">6</span> RETURN_VALUE
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里，我们定义了一个简单的 add 函数，并通过 dis 模块来查看 add 函数对应的字节码。Python 虚拟机是一个典型的栈机，其字节码执行都是基于栈来执行的，以 add 为例：</p><div class="language-python ext-py line-numbers-mode"><pre class="language-python"><code><span class="token number">0</span> LOAD_FAST                <span class="token number">0</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span>
<span class="token number">2</span> LOAD_FAST                <span class="token number">1</span> <span class="token punctuation">(</span>y<span class="token punctuation">)</span>
<span class="token number">4</span> BINARY_ADD
<span class="token number">6</span> RETURN_VALUE
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>LOAD_FAST</strong>指令会从局部变量中拿到变量值并入栈，这里会将 x，y 入栈，然后调用 <strong>BINARY_ADD</strong> 指令将栈顶的两个值出栈、相加后将结果再入栈，最后调用 <strong>RETURN_VALUE</strong>指令将栈顶值返回。</p><p>如下图所示：</p><p><img src="/imgs/python_add栈操作.png" alt="栈操作" loading="lazy"></p><p>与直接运行机器码相比，字节码执行具有良好的跨平台性，一次编译，处处运行（装有 Python 虚拟机的前提下），但也损耗了一定的性能。</p><p>而<strong>即时编译</strong>会在程序运行时，将字节码编译为机器码运行，一定程度上补偿了这种损耗。</p><p>下面，我们就用 go 来实现一个简单的 Python JIT 编译器来领略即时编译的魅力。</p><p><strong>即时编译</strong>原理虽然简单明了，但实现却很复杂，我们只会实现一个简单的 JIT 编译器，它会将类似下面的 Python 函数即时编译为机器码，然后写入内存并执行：</p><div class="language-python ext-py line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> x <span class="token operator">*</span> x <span class="token operator">-</span> y <span class="token operator">*</span> y
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>这个函数会进行简单的四则运算，并将结果返回。其对应的字节码如下：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>0 LOAD_FAST                0 (x)
2 LOAD_FAST                0 (x)
4 BINARY_MULTIPLY
6 LOAD_FAST                1 (y)
8 LOAD_FAST                1 (y)
10 BINARY_MULTIPLY
12 BINARY_SUBTRACT
14 RETURN_VALUE
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>笔者没有写代码去实现如何将 Python 代码翻译为字节码，这些编译器前端知识感兴趣的同学可以自行去查阅词法分析、语法分析等资料，或者直接去阅读 CPython 源码。</p></blockquote><p>想要将字节码直接翻译为机器码可不简单，我们需引入<a href="https://en.wikipedia.org/wiki/Intermediate_representation" target="_blank" rel="noopener noreferrer">中间代码<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>（IR，Intermediate Representation），即先将字节码翻译为 IR，然后再将 IR 翻译为机器码。</p><p>很多同学会不会疑惑多此一举？其实 IR 的存在是非常有必要的，几乎所有的编译器都有 IR，甚至可能不止一种 IR，至于 IR 的作用，在后文中笔者带领大家来体会。</p><p>我们以 foo 函数为例，看看如何将其字节码翻译为 IR。foo 的第一条字节码指令：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>LOAD_FAST                0 (x)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code>LOAD_FAST</code>会从局部变量中拿到数据，然后推入栈，LOAD_FAST 指令附带一个参数，即后面的 0，表示第 0 个局部变量，也就是 x 参数。</p><p>使用<a href="https://en.wikipedia.org/wiki/Register_allocation" target="_blank" rel="noopener noreferrer">寄存器<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>来暂存局部变量，我们可以设计出类似下面的 IR：</p><div class="language-S ext-S line-numbers-mode"><pre class="language-S"><code>push rax
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>与绝大多数汇编一样，这里将一段内存看作一个栈来操作，push 表示入栈，即将 rax 入栈。反过来，pop 表示出栈：</p><div class="language-S ext-S line-numbers-mode"><pre class="language-S"><code>pop rdi
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>这里将栈顶的值推出后，复制到 rdi。当然对于一些计算操作，比如加法：</p><div class="language-s ext-s line-numbers-mode"><pre class="language-s"><code>add rdi rsi # rdi = rdi + rsi
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>会将两个寄存器的值相加后再置入第一个寄存器中。每一个指令只做一件小事情，比如赋值、四则运算等等，类似这样的 IR 指令称为<a href="https://en.wikipedia.org/wiki/Static_single_assignment_form" target="_blank" rel="noopener noreferrer">SSA<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>。</p><p>另外，我们的 IR 指令一般都是一个操作命令，一个操作数或者两个操作数，比如：</p><div class="language-s ext-s line-numbers-mode"><pre class="language-s"><code>mov rax 100
push rax
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>为了保证统一，我们将所有 IR 指令严格限制在两个操作数中，如果不足两个，则添加一个 <code>none</code>，如下；</p><div class="language-s ext-s line-numbers-mode"><pre class="language-s"><code>mov rax 100
push rax none
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>这样的指令形式被称为 <a href="https://en.wikipedia.org/wiki/Three-address_code" target="_blank" rel="noopener noreferrer">Three-address code(TAC)<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>。</p><blockquote><p>SSA 和 TAC 都有严格的定义，这里只做了简单说明，有兴趣的同学可以点开链接查看。</p></blockquote><p>你肯定会眼熟，这不就是汇编吗？是的，我们的终极目标是翻译成机器码，而汇编是目前对机器码最好的解释码，因此我们的 IR 差不多就是一种汇编方言(Dialect)。</p><p>由于目前我们支持的字节码比较少，我们的翻译代码也很简洁明了，如下：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Compiler<span class="token punctuation">)</span> <span class="token function">Compile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>SSA<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	ir <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>SSA<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	pushSSA <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>a <span class="token builtin">string</span><span class="token punctuation">,</span> b<span class="token punctuation">,</span> c <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		ssa <span class="token operator">:=</span> <span class="token operator">&amp;</span>SSA<span class="token punctuation">{</span>
			Action<span class="token punctuation">:</span> a<span class="token punctuation">,</span>
			Arg1<span class="token punctuation">:</span>   b<span class="token punctuation">,</span>
			Arg2<span class="token punctuation">:</span>   c<span class="token punctuation">,</span>
		<span class="token punctuation">}</span>
		ir <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>ir<span class="token punctuation">,</span> ssa<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> c<span class="token punctuation">.</span>index <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Opcodes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		op <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">switch</span> op<span class="token punctuation">.</span>Code <span class="token punctuation">{</span>
		<span class="token keyword">case</span> <span class="token string">&quot;LOAD_FAST&quot;</span><span class="token punctuation">:</span>
			<span class="token function">pushSSA</span><span class="token punctuation">(</span><span class="token string">&quot;push&quot;</span><span class="token punctuation">,</span> c<span class="token punctuation">.</span><span class="token function">variable</span><span class="token punctuation">(</span>op<span class="token punctuation">.</span>Arg<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token string">&quot;STORE_FAST&quot;</span><span class="token punctuation">:</span>
			<span class="token function">pushSSA</span><span class="token punctuation">(</span><span class="token string">&quot;pop&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rdi&quot;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
			<span class="token function">pushSSA</span><span class="token punctuation">(</span><span class="token string">&quot;move&quot;</span><span class="token punctuation">,</span> c<span class="token punctuation">.</span><span class="token function">variable</span><span class="token punctuation">(</span>op<span class="token punctuation">.</span>Arg<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;rdi&quot;</span><span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token string">&quot;LOAD_CONST&quot;</span><span class="token punctuation">:</span> <span class="token comment">// 加载立即数</span>
			<span class="token function">pushSSA</span><span class="token punctuation">(</span><span class="token string">&quot;immediate&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rdi&quot;</span><span class="token punctuation">,</span> c<span class="token punctuation">.</span>Constants<span class="token punctuation">[</span>op<span class="token punctuation">.</span>Arg<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
			<span class="token function">pushSSA</span><span class="token punctuation">(</span><span class="token string">&quot;push&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rdi&quot;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token string">&quot;BINARY_MULTIPLY&quot;</span><span class="token punctuation">:</span> <span class="token comment">// 乘法</span>
			<span class="token function">pushSSA</span><span class="token punctuation">(</span><span class="token string">&quot;pop&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rdi&quot;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
			<span class="token function">pushSSA</span><span class="token punctuation">(</span><span class="token string">&quot;pop&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rsi&quot;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
			<span class="token function">pushSSA</span><span class="token punctuation">(</span><span class="token string">&quot;imul&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rdi&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rsi&quot;</span><span class="token punctuation">)</span>
			<span class="token function">pushSSA</span><span class="token punctuation">(</span><span class="token string">&quot;push&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rdi&quot;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token string">&quot;BINARY_ADD&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;INPLACE_ADD&quot;</span><span class="token punctuation">:</span> <span class="token comment">// 加法</span>
			<span class="token function">pushSSA</span><span class="token punctuation">(</span><span class="token string">&quot;pop&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rdi&quot;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
			<span class="token function">pushSSA</span><span class="token punctuation">(</span><span class="token string">&quot;pop&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rsi&quot;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
			<span class="token function">pushSSA</span><span class="token punctuation">(</span><span class="token string">&quot;add&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rdi&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rsi&quot;</span><span class="token punctuation">)</span>
			<span class="token function">pushSSA</span><span class="token punctuation">(</span><span class="token string">&quot;push&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rdi&quot;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token string">&quot;BINARY_SUBTRACT&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;INPLACE_SUBTRACT&quot;</span><span class="token punctuation">:</span> <span class="token comment">// 减法</span>
			<span class="token function">pushSSA</span><span class="token punctuation">(</span><span class="token string">&quot;pop&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rsi&quot;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
			<span class="token function">pushSSA</span><span class="token punctuation">(</span><span class="token string">&quot;pop&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rdi&quot;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
			<span class="token function">pushSSA</span><span class="token punctuation">(</span><span class="token string">&quot;sub&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rdi&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rsi&quot;</span><span class="token punctuation">)</span>
			<span class="token function">pushSSA</span><span class="token punctuation">(</span><span class="token string">&quot;push&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rdi&quot;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token string">&quot;UNARY_NEGATIVE&quot;</span><span class="token punctuation">:</span>  <span class="token comment">// -x</span>
			<span class="token function">pushSSA</span><span class="token punctuation">(</span><span class="token string">&quot;pop&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rdi&quot;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
			<span class="token function">pushSSA</span><span class="token punctuation">(</span><span class="token string">&quot;neg&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rdi&quot;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
			<span class="token function">pushSSA</span><span class="token punctuation">(</span><span class="token string">&quot;push&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rdi&quot;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token string">&quot;RETURN_VALUE&quot;</span><span class="token punctuation">:</span>  <span class="token comment">// 返回</span>
			<span class="token function">pushSSA</span><span class="token punctuation">(</span><span class="token string">&quot;pop&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rax&quot;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
			<span class="token function">pushSSA</span><span class="token punctuation">(</span><span class="token string">&quot;ret&quot;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
		<span class="token keyword">default</span><span class="token punctuation">:</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;%s not support&quot;</span><span class="token punctuation">,</span> op<span class="token punctuation">.</span>Code<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> ir<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>Compile</code> 函数负责将字节码翻译为 IR(SSA)，借助寄存器和栈，能够很迅速的将字节码翻译为对应的 IR。</p><p>运行程序，翻译 foo 函数的字节码，可以得到如下的输出：</p><div class="language-s ext-s line-numbers-mode"><pre class="language-s"><code>push rax none
push rax none
pop rdi none
pop rsi none
imul rdi rsi
push rdi none
push rbx none
push rbx none
pop rdi none
pop rsi none
imul rdi rsi
push rdi none
pop rsi none
pop rdi none
sub rdi rsi
push rdi none
pop rax none
ret none none
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到，foo 函数仅有 8 条字节码指令，但翻译为 IR 后，数量就翻倍了，而指令数量直接影响到了程序执行效率。</p><p>因此，我们加入一个简单的优化器，来优化 IR。这里不会涉及到太复杂的优化算法，我们只罗列几个简单的优化实现，比如：</p><div class="language-s ext-s line-numbers-mode"><pre class="language-s"><code>push rax none
push rax none
pop rdi none
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里 push rax 明显重复了两次，也对应了两次 LOAD_FAST，但对于寄存器分配而言，这明显重复了。</p><p>另外：</p><div class="language-s ext-s line-numbers-mode"><pre class="language-s"><code>push rax none
pop rdi none
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>现将 rax 的栈入栈，然后再将栈顶的值推出，并赋值给 rdi，这两个操作明显可以直接优化成一个操作：</p><div class="language-s ext-s line-numbers-mode"><pre class="language-s"><code>mov rdi rax
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>这里直接将 rax 的值拷贝到 rdi 就行了。对应的优化代码如下：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">if</span> op1 <span class="token operator">==</span> <span class="token string">&quot;push&quot;</span> <span class="token operator">&amp;&amp;</span> op2 <span class="token operator">==</span> <span class="token string">&quot;pop&quot;</span> <span class="token punctuation">{</span>
    index <span class="token operator">+=</span> <span class="token number">2</span>
    <span class="token function">pushSSA</span><span class="token punctuation">(</span><span class="token string">&quot;mov&quot;</span><span class="token punctuation">,</span> a2<span class="token punctuation">,</span> a1<span class="token punctuation">)</span>
    <span class="token keyword">continue</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果出现类似 <code>mov rdi rdi</code> 这样无效的复制指令，也是可以直接优化的，对应的代码如下：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">if</span> op1 <span class="token operator">==</span> <span class="token string">&quot;mov&quot;</span> <span class="token operator">&amp;&amp;</span> a1 <span class="token operator">==</span> b1 <span class="token punctuation">{</span>
    index <span class="token operator">+=</span> <span class="token number">1</span>
    <span class="token keyword">continue</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>当然也有一些其它的优化，它们都是对多余指令、重复指令的精简，整体代码如下：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Optimize</span><span class="token punctuation">(</span>ir <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>SSA<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>SSA <span class="token punctuation">{</span>
	ret <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>SSA<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	fetch <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span>
		<span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> n <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>ir<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> ir<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">.</span>Action<span class="token punctuation">,</span>
				ir<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">.</span>Arg1<span class="token punctuation">,</span> ir<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">.</span>Arg2
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>
	pushSSA <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>a <span class="token builtin">string</span><span class="token punctuation">,</span> b<span class="token punctuation">,</span> c <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		ssa <span class="token operator">:=</span> <span class="token operator">&amp;</span>SSA<span class="token punctuation">{</span>
			Action<span class="token punctuation">:</span> a<span class="token punctuation">,</span>
			Arg1<span class="token punctuation">:</span>   b<span class="token punctuation">,</span>
			Arg2<span class="token punctuation">:</span>   c<span class="token punctuation">,</span>
		<span class="token punctuation">}</span>
		ret <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>ret<span class="token punctuation">,</span> ssa<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	index <span class="token operator">:=</span> <span class="token number">0</span>
	<span class="token keyword">for</span> index <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>ir<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		op1<span class="token punctuation">,</span> a1<span class="token punctuation">,</span> b1 <span class="token operator">:=</span> <span class="token function">fetch</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span>
		op2<span class="token punctuation">,</span> a2<span class="token punctuation">,</span> b2 <span class="token operator">:=</span> <span class="token function">fetch</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
		op3<span class="token punctuation">,</span> a3<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> <span class="token function">fetch</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> op1 <span class="token operator">==</span> <span class="token string">&quot;mov&quot;</span> <span class="token operator">&amp;&amp;</span> a1 <span class="token operator">==</span> b1 <span class="token punctuation">{</span>
			index <span class="token operator">+=</span> <span class="token number">1</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> op1 <span class="token operator">==</span> <span class="token string">&quot;mov&quot;</span> <span class="token operator">&amp;&amp;</span> op2 <span class="token operator">==</span> <span class="token string">&quot;mov&quot;</span> <span class="token operator">&amp;&amp;</span> a1 <span class="token operator">==</span> b2 <span class="token punctuation">{</span>
			index <span class="token operator">+=</span> <span class="token number">2</span>
			<span class="token function">pushSSA</span><span class="token punctuation">(</span><span class="token string">&quot;mov&quot;</span><span class="token punctuation">,</span> a2<span class="token punctuation">,</span> b1<span class="token punctuation">)</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> op1 <span class="token operator">==</span> <span class="token string">&quot;push&quot;</span> <span class="token operator">&amp;&amp;</span> op2 <span class="token operator">==</span> <span class="token string">&quot;pop&quot;</span> <span class="token punctuation">{</span>
			index <span class="token operator">+=</span> <span class="token number">2</span>
			<span class="token function">pushSSA</span><span class="token punctuation">(</span><span class="token string">&quot;mov&quot;</span><span class="token punctuation">,</span> a2<span class="token punctuation">,</span> a1<span class="token punctuation">)</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> op1 <span class="token operator">==</span> <span class="token string">&quot;push&quot;</span> <span class="token operator">&amp;&amp;</span> op3 <span class="token operator">==</span> <span class="token string">&quot;pop&quot;</span> <span class="token operator">&amp;&amp;</span>
			op2 <span class="token operator">!=</span> <span class="token string">&quot;push&quot;</span> <span class="token operator">&amp;&amp;</span> op2 <span class="token operator">!=</span> <span class="token string">&quot;pop&quot;</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> a2 <span class="token operator">!=</span> a3 <span class="token punctuation">{</span>
				index <span class="token operator">+=</span> <span class="token number">3</span>
				<span class="token function">pushSSA</span><span class="token punctuation">(</span><span class="token string">&quot;mov&quot;</span><span class="token punctuation">,</span> a3<span class="token punctuation">,</span> a1<span class="token punctuation">)</span>
				<span class="token function">pushSSA</span><span class="token punctuation">(</span>op2<span class="token punctuation">,</span> a2<span class="token punctuation">,</span> b2<span class="token punctuation">)</span>
				<span class="token keyword">continue</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		index<span class="token operator">++</span>
		<span class="token function">pushSSA</span><span class="token punctuation">(</span>op1<span class="token punctuation">,</span> a1<span class="token punctuation">,</span> b1<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> ret
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们实现了一个简单的优化器，虽然简单，但效果却很好，将字节码生成的 IR 优化后，新的 IR 如下：</p><div class="language-s ext-s line-numbers-mode"><pre class="language-s"><code>mov rsi rax
mov rdi rax
imul rdi rsi
push rdi none
mov rsi rbx
mov rdi rbx
imul rdi rsi
mov rsi rdi
pop rdi none
sub rdi rsi
mov rax rdi
ret none none
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>IR 被精简了一半，大幅提高了程序运行效率。其实在这里已经体现出 IR 的强大作用，IR 具有很强的表现力，并且适合程序进行分析和优化，比起直接翻译为机器码，添加 IR 中间层是很有必要的。</p><p>得到 IR 后，我们需要将 IR 翻译为具体的机器码，这个地方的翻译是比较枯燥的，实际上就是人肉翻译，以 mov 指令为例：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>as <span class="token operator">*</span>Assembler<span class="token punctuation">)</span> <span class="token function">mov</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	as<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token number">0x48</span><span class="token punctuation">,</span> <span class="token number">0x89</span><span class="token punctuation">,</span> <span class="token number">0xc0</span><span class="token operator">|</span>as<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>as <span class="token operator">*</span>Assembler<span class="token punctuation">)</span> <span class="token function">register</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">byte</span> <span class="token punctuation">{</span>
	order <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">{</span>
		<span class="token string">&quot;rax&quot;</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
		<span class="token string">&quot;rcx&quot;</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
		<span class="token string">&quot;rdx&quot;</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
		<span class="token string">&quot;rbx&quot;</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
		<span class="token string">&quot;rsp&quot;</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
		<span class="token string">&quot;rbp&quot;</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
		<span class="token string">&quot;rsi&quot;</span><span class="token punctuation">:</span> <span class="token number">6</span><span class="token punctuation">,</span>
		<span class="token string">&quot;rdi&quot;</span><span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	enc <span class="token operator">:=</span> order<span class="token punctuation">[</span>a<span class="token punctuation">]</span>
	<span class="token keyword">if</span> b <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
		enc <span class="token operator">=</span> enc<span class="token operator">&lt;&lt;</span><span class="token number">3</span> <span class="token operator">|</span> order<span class="token punctuation">[</span>b<span class="token punctuation">]</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> enc
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>mov 指令对应的机器码实际上就是唯一的，区别在于不同的寄存器，指令的操作数会不一样，比如 rax 对应序号 0，其它操作寄存器的指令也类似于此，因此这里不做过多介绍，感兴趣的同学可以自己将程序编译为执行文件后，使用 objdump 工具来查看，整体的翻译代码如下：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>as <span class="token operator">*</span>Assembler<span class="token punctuation">)</span> <span class="token function">Assembly</span><span class="token punctuation">(</span>ir <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>SSA<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ssa <span class="token operator">:=</span> <span class="token keyword">range</span> ir <span class="token punctuation">{</span>
		name<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b <span class="token operator">:=</span> ssa<span class="token punctuation">.</span>Action<span class="token punctuation">,</span> ssa<span class="token punctuation">.</span>Arg1<span class="token punctuation">,</span> ssa<span class="token punctuation">.</span>Arg2
		<span class="token keyword">switch</span> name <span class="token punctuation">{</span>
		<span class="token keyword">case</span> <span class="token string">&quot;ret&quot;</span><span class="token punctuation">:</span>
			as<span class="token punctuation">.</span><span class="token function">ret</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token string">&quot;push&quot;</span><span class="token punctuation">:</span>
			as<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token string">&quot;pop&quot;</span><span class="token punctuation">:</span>
			as<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token string">&quot;imul&quot;</span><span class="token punctuation">:</span>
			as<span class="token punctuation">.</span><span class="token function">imul</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token string">&quot;add&quot;</span><span class="token punctuation">:</span>
			as<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token string">&quot;sub&quot;</span><span class="token punctuation">:</span>
			as<span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token string">&quot;neg&quot;</span><span class="token punctuation">:</span>
			as<span class="token punctuation">.</span><span class="token function">neg</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token string">&quot;mov&quot;</span><span class="token punctuation">:</span>
			as<span class="token punctuation">.</span><span class="token function">mov</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token string">&quot;immediate&quot;</span><span class="token punctuation">:</span>
			as<span class="token punctuation">.</span><span class="token function">immediate</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> as<span class="token punctuation">.</span>code<span class="token punctuation">[</span><span class="token punctuation">:</span>as<span class="token punctuation">.</span>index<span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>得到机器码后，JIT 的工作差不多就完成了，剩下的就是将机器码写入内存，然后执行了，如下：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	opcodes <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>py<span class="token punctuation">.</span>Opcode<span class="token punctuation">{</span> <span class="token comment">/* ... */</span> <span class="token punctuation">}</span>
	c <span class="token operator">:=</span> py<span class="token punctuation">.</span><span class="token function">NewCompiler</span><span class="token punctuation">(</span>opcodes<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token boolean">nil</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	ir<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Compile</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// ... 可根据实际的情况，来选择优化几次</span>
	ir <span class="token operator">=</span> py<span class="token punctuation">.</span><span class="token function">Optimize</span><span class="token punctuation">(</span>ir<span class="token punctuation">)</span>
	ir <span class="token operator">=</span> py<span class="token punctuation">.</span><span class="token function">Optimize</span><span class="token punctuation">(</span>ir<span class="token punctuation">)</span>
	<span class="token comment">// ....</span>
	assembler <span class="token operator">:=</span> py<span class="token punctuation">.</span><span class="token function">NewAssembler</span><span class="token punctuation">(</span><span class="token number">4096</span><span class="token punctuation">)</span>
	code <span class="token operator">:=</span> assembler<span class="token punctuation">.</span><span class="token function">Assembly</span><span class="token punctuation">(</span>ir<span class="token punctuation">)</span>
    <span class="token comment">// ...</span>
	area<span class="token punctuation">,</span> err <span class="token operator">:=</span> syscall<span class="token punctuation">.</span><span class="token function">Mmap</span><span class="token punctuation">(</span>
		<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
		<span class="token number">0</span><span class="token punctuation">,</span>
		<span class="token number">4096</span><span class="token punctuation">,</span>
		syscall<span class="token punctuation">.</span>PROT_READ<span class="token operator">|</span>syscall<span class="token punctuation">.</span>PROT_WRITE<span class="token operator">|</span>syscall<span class="token punctuation">.</span>PROT_EXEC<span class="token punctuation">,</span>
		syscall<span class="token punctuation">.</span>MAP_PRIVATE<span class="token operator">|</span>syscall<span class="token punctuation">.</span>MAP_ANON<span class="token punctuation">)</span> <span class="token comment">// linux for MAP_ANONYMOUS</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;mmap err: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> i<span class="token punctuation">,</span> by <span class="token operator">:=</span> <span class="token keyword">range</span> code <span class="token punctuation">{</span> <span class="token comment">// 选择 copy 无疑更佳</span>
		area<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> by
	<span class="token punctuation">}</span>
	<span class="token keyword">type</span> fooFunc <span class="token keyword">func</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y <span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token builtin">int64</span>
	unsafePrintFunc <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token builtin">uintptr</span><span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>area<span class="token punctuation">)</span><span class="token punctuation">)</span>
	foo <span class="token operator">:=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>fooFunc<span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unsafePrintFunc<span class="token punctuation">)</span><span class="token punctuation">)</span>
	ret <span class="token operator">:=</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里使用 mmap 映射出一段内存后，将生成的机器码写入内存，然后将其通过指针强转为函数指针，最后通过函数指针调用 foo(3,2)，得到如下结果：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token number">5</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><blockquote><p>提示一下，由于不同语言的调用约定是不一样的，go 自 1.17 使用寄存器来传参后，其参数是按照 rax, rcx, rdx 来排列的，因此如果是在其它语言下，生成的机器码是不同的。</p></blockquote><p>从结果可以发现，JIT 是成功的，一个简单的 Python JIT 编译器就这样被实现了。</p><h2 id="魔法-3-自举-bootstrap" tabindex="-1"><a class="header-anchor" href="#魔法-3-自举-bootstrap" aria-hidden="true">#</a> 魔法 3：自举(bootstrap)</h2><p>go 是自举实现的，而且是一个完全自举的编译器实现，即编译器、链接器等等都是用 go 实现的；不仅如此，go 把编译器的前端部分直接开放在了标准库中，这意味着我们不仅可以直接使用前端部分，还可以替换另外的中、后端平台来编译 go。如下：</p><p><img src="/imgs/LLVM替换.png" alt="LLVM替换" loading="lazy"></p><p>我们借助 go 标准库和 LLVM 就能实现一个非常简单的编译器，不再使用 go 默认编译器独有的 IR 和机器码生成器。</p><p>目标很明确：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">func</span> <span class="token function">add</span><span class="token punctuation">(</span>x <span class="token builtin">int</span><span class="token punctuation">,</span> y <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> x <span class="token operator">+</span> y
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>实现一个极简编译器，将这段 go 代码编译为可执行文件即可。</p><p>首先，使用 go/parser 等标准库来等 go 源代码进行解析，如下：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fset <span class="token operator">:=</span> token<span class="token punctuation">.</span><span class="token function">NewFileSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 相对于fset的position</span>
	src <span class="token operator">:=</span> <span class="token string">`package main

import &quot;fmt&quot;

func add(x int, y int) int {
	return x + y
}

func main() {
	fmt.Println(add(10, 2))
}`</span>

	f<span class="token punctuation">,</span> err <span class="token operator">:=</span> parser<span class="token punctuation">.</span><span class="token function">ParseFile</span><span class="token punctuation">(</span>fset<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> src<span class="token punctuation">,</span> parser<span class="token punctuation">.</span>AllErrors<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	ast<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span>fset<span class="token punctuation">,</span> f<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>由于 go 良好的自举设计，我们可以轻松得到这段代码的 AST 树：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>0  *ast.File {
1  .  Package: 1:1
2  .  Name: *ast.Ident {
3  .  .  NamePos: 1:9
4  .  .  Name: &quot;main&quot;
5  .  }
6  .  Decls: []ast.Decl (len = 3) {
7  .  .  0: *ast.GenDecl {
8  .  .  .  TokPos: 3:1
9  .  .  .  Tok: import
.... 省略
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>LLVM 为了屏蔽不同平台架构之间的指令差异性，设计了一种 IR，举例：</p><div class="language-ll ext-ll line-numbers-mode"><pre class="language-ll"><code>define i32 @add(i32 %a, i32 %b) {
  %1 = add i32 %a, %b
  ret i32 %1
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>LLVM 的 IR 不同于上面提到的汇编方言，而是一种更加高级的抽象，有基本的函数定义、分支等，更像是一种 low level C。</p><p>LLVM 的编译器 clang 是支持直接将 IR 编译为可执行文件的，在编译的过程中会自动对 IR、机器码进行优化，这也是 LLVM 近些年火爆的原因，很多语言搭上了 LLVM 的快车，比如 Rust 等。</p><p>所以，任务更加简单了，只需要在 AST 树翻译为 LLVM IR 即可。实际上，有一些项目就是采用这种做法，比如 <a href="https://go.googlesource.com/gollvm/" target="_blank" rel="noopener noreferrer">gollvm<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>和 <a href="https://tinygo.org/" target="_blank" rel="noopener noreferrer">tinygo<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 等。</p><p>当然，一门语言的语法翻译也不是一件易事，感兴趣的同学可以点开 gollvm 和 tinygo 的链接看看它们是如何做的，这里笔者仅简单的翻译上面的例子。</p><p>得到 AST 树后，我们需要拿到 add、main 函数的定义，并将其翻译为 IR，如下：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> decl <span class="token operator">:=</span> <span class="token keyword">range</span> f<span class="token punctuation">.</span>Decls <span class="token punctuation">{</span>
	<span class="token keyword">if</span> fn<span class="token punctuation">,</span> ok <span class="token operator">:=</span> decl<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>ast<span class="token punctuation">.</span>FuncDecl<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
		<span class="token keyword">if</span> fn<span class="token punctuation">.</span>Name<span class="token punctuation">.</span>Name <span class="token operator">==</span> <span class="token string">&quot;add&quot;</span> <span class="token punctuation">{</span>
			<span class="token function">translateAdd</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> funcMap<span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> fn<span class="token punctuation">.</span>Name<span class="token punctuation">.</span>Name <span class="token operator">==</span> <span class="token string">&quot;main&quot;</span> <span class="token punctuation">{</span>
			<span class="token function">translateMain</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> funcMap<span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对于 add 函数，没有复杂的函数体，我们提取出参数、返回值然后生成对应的 IR 即可：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">translateAdd</span><span class="token punctuation">(</span>m <span class="token operator">*</span>ir<span class="token punctuation">.</span>Module<span class="token punctuation">,</span> decl <span class="token operator">*</span>ast<span class="token punctuation">.</span>FuncDecl<span class="token punctuation">,</span> funcMap <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>ir<span class="token punctuation">.</span>Func<span class="token punctuation">)</span> <span class="token operator">*</span>ir<span class="token punctuation">.</span>Func <span class="token punctuation">{</span>
	params <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>ir<span class="token punctuation">.</span>Param<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> field <span class="token operator">:=</span> <span class="token keyword">range</span> decl<span class="token punctuation">.</span>Type<span class="token punctuation">.</span>Params<span class="token punctuation">.</span>List <span class="token punctuation">{</span>
		paramName <span class="token operator">:=</span> field<span class="token punctuation">.</span>Names<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Name
		paramType <span class="token operator">:=</span> field<span class="token punctuation">.</span>Type<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>ast<span class="token punctuation">.</span>Ident<span class="token punctuation">)</span><span class="token punctuation">.</span>Name
		<span class="token keyword">if</span> paramType <span class="token operator">!=</span> <span class="token string">&quot;int&quot;</span> <span class="token punctuation">{</span> <span class="token comment">// 暂不支持</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>
		params <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> ir<span class="token punctuation">.</span><span class="token function">NewParam</span><span class="token punctuation">(</span>paramName<span class="token punctuation">,</span> types<span class="token punctuation">.</span>I32<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	returnType <span class="token operator">:=</span> decl<span class="token punctuation">.</span>Type<span class="token punctuation">.</span>Results<span class="token punctuation">.</span>List<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Type<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>ast<span class="token punctuation">.</span>Ident<span class="token punctuation">)</span><span class="token punctuation">.</span>Name
	<span class="token keyword">if</span> returnType <span class="token operator">!=</span> <span class="token string">&quot;int&quot;</span> <span class="token punctuation">{</span> <span class="token comment">// 暂不支持</span>
		<span class="token function">panic</span><span class="token punctuation">(</span>returnType <span class="token operator">+</span> <span class="token string">&quot; return type is not support&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	funcDefine <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">NewFunc</span><span class="token punctuation">(</span>decl<span class="token punctuation">.</span>Name<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> types<span class="token punctuation">.</span>I32<span class="token punctuation">,</span> params<span class="token operator">...</span><span class="token punctuation">)</span>
	ab <span class="token operator">:=</span> funcDefine<span class="token punctuation">.</span><span class="token function">NewBlock</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
	ab<span class="token punctuation">.</span><span class="token function">NewRet</span><span class="token punctuation">(</span>ab<span class="token punctuation">.</span><span class="token function">NewAdd</span><span class="token punctuation">(</span>funcDefine<span class="token punctuation">.</span>Params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> funcDefine<span class="token punctuation">.</span>Params<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	funcMap<span class="token punctuation">[</span>decl<span class="token punctuation">.</span>Name<span class="token punctuation">.</span>Name<span class="token punctuation">]</span> <span class="token operator">=</span> funcDefine
	<span class="token keyword">return</span> funcDefine
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>而在 main 函数中，我们不仅需要调用 add 函数，还需要调用 println 函数来打印结果，所以，我们提前定义一个 printf 内置函数，并将其加入到哈希表中方便后续查找：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// builtin</span>
printf <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">NewFunc</span><span class="token punctuation">(</span>
	<span class="token string">&quot;printf&quot;</span><span class="token punctuation">,</span>
	types<span class="token punctuation">.</span>I32<span class="token punctuation">,</span>
	ir<span class="token punctuation">.</span><span class="token function">NewParam</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> types<span class="token punctuation">.</span><span class="token function">NewPointer</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span>I8<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
printf<span class="token punctuation">.</span>Sig<span class="token punctuation">.</span>Variadic <span class="token operator">=</span> <span class="token boolean">true</span>

funcMap <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>ir<span class="token punctuation">.</span>Func<span class="token punctuation">{</span>
		<span class="token string">&quot;printf&quot;</span><span class="token punctuation">:</span> printf<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>main 函数中，需要对 add 函数的参数进行处理，如下：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">translateMain</span><span class="token punctuation">(</span>m <span class="token operator">*</span>ir<span class="token punctuation">.</span>Module<span class="token punctuation">,</span> decl <span class="token operator">*</span>ast<span class="token punctuation">.</span>FuncDecl<span class="token punctuation">,</span> funcMap <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>ir<span class="token punctuation">.</span>Func<span class="token punctuation">)</span> <span class="token operator">*</span>ir<span class="token punctuation">.</span>Func <span class="token punctuation">{</span>
	zero <span class="token operator">:=</span> constant<span class="token punctuation">.</span><span class="token function">NewInt</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span>I32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	stmt <span class="token operator">:=</span> decl<span class="token punctuation">.</span>Body<span class="token punctuation">.</span>List<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>ast<span class="token punctuation">.</span>ExprStmt<span class="token punctuation">)</span><span class="token punctuation">.</span>X<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>ast<span class="token punctuation">.</span>CallExpr<span class="token punctuation">)</span><span class="token punctuation">.</span>Args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>ast<span class="token punctuation">.</span>CallExpr<span class="token punctuation">)</span>
	args <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>value<span class="token punctuation">.</span>Value<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> item <span class="token operator">:=</span> <span class="token keyword">range</span> stmt<span class="token punctuation">.</span>Args <span class="token punctuation">{</span>
		val <span class="token operator">:=</span> item<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>ast<span class="token punctuation">.</span>BasicLit<span class="token punctuation">)</span><span class="token punctuation">.</span>Value
		i<span class="token punctuation">,</span> err <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">ParseInt</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>
		args <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> constant<span class="token punctuation">.</span><span class="token function">NewInt</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span>I32<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	funcMain <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">NewFunc</span><span class="token punctuation">(</span><span class="token string">&quot;main&quot;</span><span class="token punctuation">,</span> types<span class="token punctuation">.</span>I32<span class="token punctuation">)</span>
	mb <span class="token operator">:=</span> funcMain<span class="token punctuation">.</span><span class="token function">NewBlock</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
	result <span class="token operator">:=</span> mb<span class="token punctuation">.</span><span class="token function">NewCall</span><span class="token punctuation">(</span>funcMap<span class="token punctuation">[</span><span class="token string">&quot;add&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> args<span class="token operator">...</span><span class="token punctuation">)</span>
	formatStr <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">NewGlobalDef</span><span class="token punctuation">(</span><span class="token string">&quot;formatStr&quot;</span><span class="token punctuation">,</span> constant<span class="token punctuation">.</span><span class="token function">NewCharArrayFromString</span><span class="token punctuation">(</span><span class="token string">&quot;%d\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	format <span class="token operator">:=</span> constant<span class="token punctuation">.</span><span class="token function">NewGetElementPtr</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span><span class="token function">NewArray</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> types<span class="token punctuation">.</span>I8<span class="token punctuation">)</span><span class="token punctuation">,</span> formatStr<span class="token punctuation">,</span> zero<span class="token punctuation">,</span> zero<span class="token punctuation">)</span>
	mb<span class="token punctuation">.</span><span class="token function">NewCall</span><span class="token punctuation">(</span>funcMap<span class="token punctuation">[</span><span class="token string">&quot;printf&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> format<span class="token punctuation">,</span> result<span class="token punctuation">)</span>
	mb<span class="token punctuation">.</span><span class="token function">NewRet</span><span class="token punctuation">(</span>zero<span class="token punctuation">)</span>
	<span class="token keyword">return</span> funcMain
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后，我们将得到的 IR 打印并写入文件，并调用 clang 编译为执行文件：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fset <span class="token operator">:=</span> token<span class="token punctuation">.</span><span class="token function">NewFileSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 相对于fset的position</span>
	src <span class="token operator">:=</span> <span class="token string">`package main

import &quot;fmt&quot;

func add(x int, y int) int {
	return x + y
}

func main() {
	fmt.Println(add(10, 2))
}`</span>
	f<span class="token punctuation">,</span> err <span class="token operator">:=</span> parser<span class="token punctuation">.</span><span class="token function">ParseFile</span><span class="token punctuation">(</span>fset<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> src<span class="token punctuation">,</span> parser<span class="token punctuation">.</span>AllErrors<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	m <span class="token operator">:=</span> ir<span class="token punctuation">.</span><span class="token function">NewModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// builtin</span>
	printf <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">NewFunc</span><span class="token punctuation">(</span>
		<span class="token string">&quot;printf&quot;</span><span class="token punctuation">,</span>
		types<span class="token punctuation">.</span>I32<span class="token punctuation">,</span>
		ir<span class="token punctuation">.</span><span class="token function">NewParam</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> types<span class="token punctuation">.</span><span class="token function">NewPointer</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span>I8<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">)</span>
	printf<span class="token punctuation">.</span>Sig<span class="token punctuation">.</span>Variadic <span class="token operator">=</span> <span class="token boolean">true</span>
	funcMap <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>ir<span class="token punctuation">.</span>Func<span class="token punctuation">{</span>
		<span class="token string">&quot;printf&quot;</span><span class="token punctuation">:</span> printf<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> decl <span class="token operator">:=</span> <span class="token keyword">range</span> f<span class="token punctuation">.</span>Decls <span class="token punctuation">{</span>
		<span class="token keyword">if</span> fn<span class="token punctuation">,</span> ok <span class="token operator">:=</span> decl<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>ast<span class="token punctuation">.</span>FuncDecl<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
			<span class="token keyword">if</span> fn<span class="token punctuation">.</span>Name<span class="token punctuation">.</span>Name <span class="token operator">==</span> <span class="token string">&quot;add&quot;</span> <span class="token punctuation">{</span>
				<span class="token function">translateAdd</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> funcMap<span class="token punctuation">)</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> fn<span class="token punctuation">.</span>Name<span class="token punctuation">.</span>Name <span class="token operator">==</span> <span class="token string">&quot;main&quot;</span> <span class="token punctuation">{</span>
				<span class="token function">translateMain</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> funcMap<span class="token punctuation">)</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token keyword">continue</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	err <span class="token operator">=</span> ioutil<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span><span class="token string">&quot;./add.ll&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0666</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	err <span class="token operator">=</span> exec<span class="token punctuation">.</span><span class="token function">Command</span><span class="token punctuation">(</span><span class="token string">&quot;clang&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./add.ll&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>运行程序，我们可以在命令行中看到生成的 IR：</p><div class="language-ll ext-ll line-numbers-mode"><pre class="language-ll"><code>@formatStr = global [3 x i8] c&quot;%d\0A&quot;

declare i32 @printf(i8* %0, ...)

define i32 @add(i32 %x, i32 %y) {
0:
        %1 = add i32 %x, %y
        ret i32 %1
}

define i32 @main() {
0:
        %1 = call i32 @add(i32 10, i32 2)
        %2 = call i32 (i8*, ...) @printf(i8* getelementptr ([3 x i8], [3 x i8]* @formatStr, i32 0, i32 0), i32 %1)
        ret i32 0
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>且在当前文件夹下有 a.out 可执行文件，我们尝试运行它：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ ./a.out
<span class="token number">12</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>至此，一个极简的 go 自举编译器就实现了，我们也顺利得到了正确的结果。</p><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h2><p>很明显，本文内容与编译器强相关，编译器是一个极其有意思的主题，希望本文能带给你一个新的编译器视角，然后去学习、实践它。</p><p>体验不一样的乐趣。</p><h2 id="参考资料" tabindex="-1"><a class="header-anchor" href="#参考资料" aria-hidden="true">#</a> 参考资料</h2><ul><li><a href="https://github.com/golang/go" target="_blank" rel="noopener noreferrer">go<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://github.com/gopher-os/gopher-os" target="_blank" rel="noopener noreferrer">gopher-os<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://github.com/icexin/eggos" target="_blank" rel="noopener noreferrer">eggos<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://xargin.com/go1-17-new-calling-convention/" target="_blank" rel="noopener noreferrer">Go 1.17 的新调用规约<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://csl.name/post/python-compiler/" target="_blank" rel="noopener noreferrer">JIT compiling a subset of Python to x86-64<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://en.wikipedia.org/wiki/Exit_(system_call)" target="_blank" rel="noopener noreferrer">Exit_(system_call)<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://tinygo.org/" target="_blank" rel="noopener noreferrer">tinygo<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://github.com/llir/llvm" target="_blank" rel="noopener noreferrer">llir<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li></ul></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/pedrogao/pedrogao.github.io/edit/main/posts/go/magic2.md" rel="noopener noreferrer" target="_blank" aria-label="编辑此页" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->编辑此页<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item update-time"><span class="label">上次编辑于: </span><span class="info">2022/5/29 08:00:33</span></div><div class="meta-item contributors"><span class="label">贡献者: </span><!--[--><!--[--><span class="contributor" title="email: 1312342604@qq.com">pedrogao</span><!--]--><!--]--></div></footer><nav class="page-nav"><a href="/posts/go/magic.html" class="nav-link prev" aria-label="go 的两个黑魔法技巧"><div class="hint"><span class="arrow left"></span>上一页</div><div class="link"><span class="icon iconfont icon-edit" style=""></span>go 的两个黑魔法技巧</div></a><!----></nav><!----><!----><!--]--></main><!--]--><footer class="footer-wrapper"><div class="footer">当开始算运气的时候，就不太可能被运气照顾。</div><div class="copyright">Copyright © 2022 pedrogao</div></footer><!--]--></div><!--]--><!----><!--]--></div>
    <script type="module" src="/assets/app.7136131a.js" defer></script>
  </body>
</html>
